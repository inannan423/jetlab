import React, { useState, useEffect } from 'react'
import Exb from '../../../components/Exb'
import { Callout } from 'nextra-theme-docs'

# ç»†ç²’åº¦æ›´æ–°

åœ¨å…¸å‹çš„å‰ç«¯æ¡†æ¶ä¸­ï¼Œæœ‰ä¸€ç§ç»†ç²’åº¦çš„æ›´æ–°æœºåˆ¶ï¼Œç»†ç²’åº¦æ›´æ–°å®é™…ä¸Šæ˜¯åœ¨è‡ªåŠ¨å¯¹ä»¥æ¥è¿›è¡Œè¿½è¸ªï¼Œä»¥ä¾¿åœ¨æ›´æ–°æ—¶åªæ›´æ–°éœ€è¦æ›´æ–°çš„éƒ¨åˆ†ã€‚åœ¨ React ä¸­ï¼Œç»†ç²’åº¦æ›´æ–°ä½“ç°åœ¨ `useState` ä»¥åŠ `useEffect` ä¸­ï¼Œå½“çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ï¼Œåªä¼šæ›´æ–°éœ€è¦æ›´æ–°çš„éƒ¨åˆ†ï¼Œè€Œä¸æ˜¯æ•´ä¸ªç»„ä»¶ã€‚åœ¨ Vue ä¸­ï¼Œç»†ç²’åº¦æ›´æ–°ä½“ç°åœ¨ `watch` ä»¥åŠ `computed` ä¸­ã€‚

ä¸€ä¸ªæœ€ä¸ºå…¸å‹çš„ä¾‹å­å¦‚ä¸‹ï¼š

```jsx
import React, { useState, useEffect } from 'react';

export function Example1(){
  const [count, setCount] = useState(0);
  useEffect(()=>{
    if (count > 10){
      setCount(0);
    }
  }, [count]);
  return (
    <div>
        {count}
        <button onClick={() => setCount(count + 1)}>+</button>
    </div>
  )
}
```

export function Example1 () {
  const [count, setCount] = useState(0)
  useEffect(() => {
    if (count > 10) {
      setCount(0)
    }
  }, [count])
  return (
    <div className={'flex h-max'}>
      {count}
      <button className={'ml-5 h-5 text-blue-500 flex items-center justify-center text-center text-2xl'} onClick={() => setCount(count + 1)}>+</button>
    </div>
  )
}

<Exb>
<Example1 />
</Exb>

åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ `useState` å’Œ `useEffect` æ¥å®ç°ä¸€ä¸ªè®¡æ•°å™¨ï¼Œå½“è®¡æ•°å™¨çš„å€¼å¤§äº 10 æ—¶ï¼Œé‡ç½®ä¸º 0ã€‚åœ¨è¿™é‡Œå‰¯ä½œç”¨æœ‰ä¸€ä¸ªä¾èµ– `count`ï¼Œå½“ `count` å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå‰¯ä½œç”¨ä¼šé‡æ–°æ‰§è¡Œã€‚åœ¨è¿™é‡Œï¼Œå½“ `count` å‘ç”Ÿå˜åŒ–æ—¶ï¼Œåªæœ‰è®¡æ•°å™¨çš„å€¼å‘ç”Ÿäº†å˜åŒ–ï¼Œè€Œä¸æ˜¯æ•´ä¸ªç»„ä»¶ã€‚é‚£ä¹ˆè®©æˆ‘ä»¬æ¥å®ç°ä¸€ä¸ªç®€å•çš„å®ä¾‹ï¼Œå®ç°ç»†ç²’åº¦æ›´æ–°ã€‚

## è®¢é˜…å‘å¸ƒæ¨¡å¼

åœ¨å®ç°ç»†ç²’åº¦æ›´æ–°çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å®ç°ä¸€ä¸ªè®¢é˜…å‘å¸ƒæ¨¡å¼ï¼Œè®¢é˜…å‘å¸ƒæ¨¡å¼æ˜¯ä¸€ç§è®¾è®¡æ¨¡å¼ï¼Œå®ƒå®šä¹‰äº†ä¸€ç§ä¸€å¯¹å¤šçš„ä¾èµ–å…³ç³»ï¼Œè®©å¤šä¸ªè§‚å¯Ÿè€…å¯¹è±¡åŒæ—¶ç›‘å¬æŸä¸€ä¸ªä¸»é¢˜å¯¹è±¡ï¼Œè¿™ä¸ªä¸»é¢˜å¯¹è±¡çš„çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ï¼Œä¼šé€šçŸ¥æ‰€æœ‰è§‚å¯Ÿè€…å¯¹è±¡ï¼Œä½¿å®ƒä»¬èƒ½å¤Ÿè‡ªåŠ¨æ›´æ–°è‡ªå·±ã€‚

å‘å¸ƒè®¢é˜…æ¨¡å¼æ˜¯ä¸€ç§å®šä¹‰å¯¹è±¡é—´ä¸€å¯¹å¤šçš„ä¾èµ–å…³ç³»çš„è®¾è®¡æ¨¡å¼ï¼Œå½“ä¸€ä¸ªå¯¹è±¡çš„çŠ¶æ€å‘ç”Ÿæ”¹å˜æ—¶ï¼Œæ‰€æœ‰ä¾èµ–äºå®ƒçš„å¯¹è±¡éƒ½å°†å¾—åˆ°é€šçŸ¥ã€‚åœ¨ JavaScript ä¸­ï¼Œå‘å¸ƒè®¢é˜…æ¨¡å¼åˆè¢«ç§°ä¸ºè§‚å¯Ÿè€…æ¨¡å¼ã€‚å®ƒå¯ä»¥å¹¿æ³›åº”ç”¨äºå¼‚æ­¥ç¼–ç¨‹ä¸­ï¼Œè¿™æ˜¯ä¸€ç§æ›¿ä»£ä¼ é€’å›è°ƒå‡½æ•°çš„æ–¹æ¡ˆã€‚æ¯”å¦‚ï¼Œå¯ä»¥è®¢é˜… ajax è¯·æ±‚çš„ errorã€succ ç­‰äº‹ä»¶ã€‚æ— éœ€è¿‡å¤šå…³æ³¨å¯¹è±¡åœ¨å¼‚æ­¥è¿è¡ŒæœŸé—´çš„å†…éƒ¨çŠ¶æ€ï¼Œè€Œåªéœ€è¦è®¢é˜…æ„Ÿå…´è¶£çš„äº‹ä»¶å‘ç”Ÿç‚¹ã€‚

## `useState`

`useState` ç”¨äºå­˜å‚¨ä¸€ä¸ªçŠ¶æ€ï¼Œå½“è¿™ä¸ªçŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå®ƒä¼šç‰µåŠ¨ UI æ¸²æŸ“å‘ç”Ÿå˜åŒ–ï¼Œä»¥åŠä¸ä¹‹ç›¸å…³çš„å‰¯ä½œç”¨å‘ç”Ÿå˜åŒ–ã€‚åœ¨ `useState` ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ä¼ å…¥ä¸€ä¸ªåˆå§‹å€¼ï¼Œå®ƒä¼šè¿”å›ä¸€ä¸ªæ•°ç»„ï¼Œç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯å½“å‰çš„çŠ¶æ€ï¼Œç¬¬äºŒä¸ªå…ƒç´ æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œç”¨äºæ›´æ–°çŠ¶æ€ã€‚

åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä½¿ç”¨ `myUseState` æ¥å®ç°ä¸€ä¸ªç®€å•çš„ `useState`ï¼Œå®ƒæ¥æ”¶ä¸€ä¸ªåˆå§‹å€¼ï¼Œè¿”å›ä¸€ä¸ªæ•°ç»„ï¼Œç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯å½“å‰çš„çŠ¶æ€ï¼Œç¬¬äºŒä¸ªå…ƒç´ æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œç”¨äºæ›´æ–°çŠ¶æ€ã€‚

```jsx {6}
function myUseState(initialValue){
  const getter = () => initialValue;
  const setter = (newValue) => {
      initialValue = newValue;
  }
  return [getter, setter];
}
```

export function myUseState (initialValue) {
  const getter = () => initialValue
  const setter = (newValue) => {
    console.log(newValue)
    initialValue = newValue
  }
  return [getter, setter]
}

export function Example2 () {
  const [count, setCount] = myUseState(0)
  return (
    <div className={'flex h-max'}>
      {count()}
      <button className={'ml-5 h-5 text-blue-500 flex items-center justify-center text-center text-2xl'} onClick={() => setCount(count() + 1)}>+</button>
    </div>
  )
}

ä½¿ç”¨ç¤ºä¾‹å¦‚ä¸‹ï¼Œä½†æ˜¯ä½ ä¼šå‘ç°ç‚¹å‡»åï¼Œè®¡æ•°å™¨çš„å€¼å¹¶æ²¡æœ‰å‘ç”Ÿå˜åŒ–ã€‚è¿™æ˜¯å› ä¸ºæˆ‘ä»¬è¿˜æ²¡å®ç°æ›´æ–°çŠ¶æ€çš„åŠŸèƒ½ã€‚ä½†æ˜¯ä½ æ‰“å¼€æ§åˆ¶å°ï¼Œä½ ä¼šå‘ç°ï¼Œå½“ç‚¹å‡»æŒ‰é’®æ—¶ï¼Œ`count` çš„å€¼ç¡®å®å‘ç”Ÿäº†å˜åŒ–ã€‚

<Exb>
<Example2 />
</Exb>

<Callout type="info" emoji="â„¹ï¸">
  å¤ä¹ ï¼šä»€ä¹ˆæ˜¯é—­åŒ…ï¼Ÿé—­åŒ…æ˜¯æŒ‡æœ‰æƒè®¿é—®å¦ä¸€ä¸ªå‡½æ•°ä½œç”¨åŸŸä¸­çš„å˜é‡çš„å‡½æ•°ã€‚åˆ›å»ºé—­åŒ…çš„å¸¸è§æ–¹å¼ï¼Œå°±æ˜¯åœ¨ä¸€ä¸ªå‡½æ•°å†…éƒ¨åˆ›å»ºå¦ä¸€ä¸ªå‡½æ•°ã€‚
</Callout>

è¿™é‡Œæˆ‘ä»¬å®šä¹‰äº†ä¸¤ä¸ªå‡½æ•°ï¼Œ`getter` ç”¨äºå–å€¼ï¼Œ`setter` ç”¨äºæ›´æ–°å€¼ï¼Œæˆ‘ä»¬å°†è¿™ä¸¤ä¸ªå‡½æ•°è¿”å›ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨å¤–éƒ¨ä½¿ç”¨ `getter` å’Œ `setter` æ¥è·å–å’Œæ›´æ–°çŠ¶æ€ã€‚è¿™é‡Œå®é™…ä¸Šå½¢æˆäº†ä¸€ä¸ªé—­åŒ…å‡½æ•°ã€‚æ³¨æ„è¿™é‡Œä¸ React æœ‰ä¸€ç‚¹ä¸åŒï¼Œæˆ‘ä»¬è¿”å›çš„æ•°ç»„ç¬¬ä¸€ä¸ªå…ƒç´ å¹¶ä¸æ˜¯å€¼ï¼Œè€Œæ˜¯ getter ï¼Œè¿™åœ¨åé¢ä¼šæåˆ°ã€‚

## `useEffect`

æ¥ä¸‹æ¥æˆ‘ä»¬å®ç° `useEffect`ï¼Œå®ƒç”¨äºæ‰§è¡Œå‰¯ä½œç”¨ï¼Œå½“ä¾èµ–å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå®ƒä¼šé‡æ–°æ‰§è¡Œã€‚ä»–çš„è¡Œä¸ºæ˜¯ï¼š

- useEffect æ‰§è¡Œåï¼Œå›è°ƒå‡½æ•°ç«‹åˆ»æ‰§è¡Œã€‚
- ä¾èµ–çš„è‡ªå˜é‡å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå›è°ƒå‡½æ•°ä¼šé‡æ–°æ‰§è¡Œã€‚
- ä¸éœ€è¦æ˜¾å¼æŒ‡æ˜ä¾èµ–ã€‚

å¦‚ï¼š

```jsx
const [count, setCount] = myUseState(0);

useEffect(() => {
  console.log('count changed'+count()); // è‡ªåŠ¨ä¾èµ– count
});

useEffect(() => {
  console.log('ä½ å¥½å‘€'); // ä¸ä¾èµ–ä»»ä½•å˜é‡ï¼Œå› æ­¤ count å˜åŒ–æ—¶ä¸ä¼šæ‰§è¡Œ
});

setCount(1);
```
å®ç°çš„å…³é”®åœ¨äºå»ºç«‹ myUseState ä¸ myUseState ä¹‹é—´çš„è®¢é˜…å‘å¸ƒå…³ç³»ã€‚æˆ‘ä»¬åœ¨ myUseState ä¸­ç»´æŠ¤ä¸€ä¸ªè®¢é˜…è€…åˆ—è¡¨ï¼Œæ¥ä¿å­˜è®¢é˜…è¿™ä¸ª state å˜åŒ–çš„ effectã€‚effect æœ‰ä¸‹é¢çš„æ•°æ®ç»“æ„ï¼š

```jsx
const effect = {
  // effect çš„å›è°ƒå‡½æ•°
  execute,
  // ä¿å­˜è¯¥ useEffect ä¾èµ–çš„ state çš„å¯¹åº” subs çš„é›†åˆ
  deps: new Set(),
}
```
è¿™é‡Œè®©æˆ‘ä»¬å…³æ³¨ä¸¤ä¸ªä¸œè¥¿ï¼Œä¸€ä¸ªæ˜¯ `execute`ï¼Œå®ƒæ˜¯ effect çš„å›è°ƒå‡½æ•°ï¼Œå¦ä¸€ä¸ªæ˜¯ `deps`ï¼Œå®ƒæ˜¯ä¸€ä¸ªé›†åˆï¼Œç”¨äºä¿å­˜è¯¥ effect ä¾èµ–çš„ state çš„å¯¹åº” subs çš„é›†åˆã€‚

`Set()` æ˜¯ ES6 ä¸­æ–°å¢çš„æ•°æ®ç»“æ„ï¼Œå®ƒç±»ä¼¼äºæ•°ç»„ï¼Œä½†æ˜¯æˆå‘˜çš„å€¼éƒ½æ˜¯å”¯ä¸€çš„ï¼Œæ²¡æœ‰é‡å¤çš„å€¼ã€‚å®ƒæœ‰ä»¥ä¸‹çš„æ–¹æ³•ï¼š

- `add(value)`ï¼šæ·»åŠ æŸä¸ªå€¼ï¼Œè¿”å› Set ç»“æ„æœ¬èº«ã€‚
- `delete(value)`ï¼šåˆ é™¤æŸä¸ªå€¼ï¼Œè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºåˆ é™¤æ˜¯å¦æˆåŠŸã€‚
- `has(value)`ï¼šè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºè¯¥å€¼æ˜¯å¦ä¸º Set çš„æˆå‘˜ã€‚
- `clear()`ï¼šæ¸…é™¤æ‰€æœ‰æˆå‘˜ï¼Œæ²¡æœ‰è¿”å›å€¼ã€‚
- ...

```js
let mySet = new Set();

mySet.add(1); // Set [ 1 ]
mySet.add(5); // Set [ 1, 5 ]
mySet.add(5); // Set [ 1, 5 ]
mySet.add("some text"); // Set [ 1, 5, "some text" ]
let o = {a: 1, b: 2};
mySet.add(o);

mySet.add({a: 1, b: 2}); // o æŒ‡å‘çš„æ˜¯ä¸åŒçš„å¯¹è±¡ï¼Œæ‰€ä»¥æ²¡é—®é¢˜

mySet.has(1); // true
mySet.has(3); // false
mySet.has(5);              // true
mySet.has(Math.sqrt(25));  // true
mySet.has("Some Text".toLowerCase()); // true
mySet.has(o); // true

mySet.size; // 5

mySet.delete(5);  // trueï¼Œä» set ä¸­ç§»é™¤ 5
mySet.has(5);     // false, 5 å·²ç»è¢«ç§»é™¤

mySet.size; // 4ï¼Œåˆšåˆšç§»é™¤ä¸€ä¸ªå€¼

console.log(mySet);
// logs Set(4) [ 1, "some text", {â€¦}, {â€¦} ] in Firefox
// logs Set(4) { 1, "some text", {â€¦}, {â€¦} } in Chrome
```

å‚è€ƒ [MDN SetğŸ–±](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Set)

é€šè¿‡éå† state.subs å¯ä»¥æ‰¾åˆ°æ‰€æœ‰è®¢é˜…è¿™ä¸ª state å˜åŒ–çš„ effectï¼Œç„¶åå°†éå† effect.deps å¯ä»¥æ‰¾åˆ°æ‰€æœ‰è¯¥ effect ä¾èµ–çš„ stateï¼Œç„¶åå°† effect æ·»åŠ åˆ°è¿™äº› state çš„ subs ä¸­ã€‚

```jsx
function myUseEffect (callback) {
  const execute = () => {
    // é‡ç½®ä¾èµ–
    cleanup(effect);
    // å°†å½“å‰ effect æ¨åˆ°æ ˆé¡¶
    effectStack.push(effect);
    try {
      // æ‰§è¡Œå›è°ƒå‡½æ•°
      callback();
    } finally {
      // å°†å½“å‰ effect ä»æ ˆé¡¶å¼¹å‡º
      effectStack.pop();
    }
  }
  const effect = {
    execute,
    deps: new Set(),
  }
  execute();
}
```
è¿™é‡Œåœ¨æ‰§è¡Œå›è°ƒå‡½æ•°å‰æˆ‘ä»¬ä½¿ç”¨ cleanup å‡½æ•°æ¥é‡ç½®ä¾èµ–ï¼Œè¿™æ˜¯å› ä¸ºå½“ä¾èµ–å‘ç”Ÿå˜åŒ–æ—¶ï¼Œæˆ‘ä»¬éœ€è¦å°† effect ä»åŸæ¥çš„ state çš„ subs ä¸­ç§»é™¤ï¼Œç„¶åå†æ·»åŠ åˆ°æ–°çš„ state çš„ subs ä¸­ã€‚è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ `Set` æ¥ä¿å­˜ä¾èµ–ï¼Œå› ä¸º `Set` ä¸­çš„æˆå‘˜æ˜¯å”¯ä¸€çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡ `Set` æ¥åˆ¤æ–­ä¾èµ–æ˜¯å¦å‘ç”Ÿå˜åŒ–ã€‚

```jsx filename="cleanup.js"
function cleanup (effect) {
  // ä»è¯¥ effect ä¾èµ–çš„ state çš„ subs ä¸­ç§»é™¤è¯¥ effect
  for (const state of effect.deps) {
    state.subs.delete(effect);
  }
  // æ¸…ç©ºè¯¥ effect ä¾èµ–çš„ state çš„é›†åˆ
  effect.deps.clear();
}
```
