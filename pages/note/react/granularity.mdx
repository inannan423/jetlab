import React, { useState, useEffect } from 'react'
import Exb from '../../../components/Exb'
import { Callout } from 'nextra-theme-docs'

# ç»†ç²’åº¦æ›´æ–°

åœ¨å…¸å‹çš„å‰ç«¯æ¡†æ¶ä¸­ï¼Œæœ‰ä¸€ç§ç»†ç²’åº¦çš„æ›´æ–°æœºåˆ¶ï¼Œç»†ç²’åº¦æ›´æ–°å®é™…ä¸Šæ˜¯åœ¨è‡ªåŠ¨å¯¹ä»¥æ¥è¿›è¡Œè¿½è¸ªï¼Œä»¥ä¾¿åœ¨æ›´æ–°æ—¶åªæ›´æ–°éœ€è¦æ›´æ–°çš„éƒ¨åˆ†ã€‚åœ¨ React ä¸­ï¼Œç»†ç²’åº¦æ›´æ–°ä½“ç°åœ¨ `useState` ä»¥åŠ `useEffect` ä¸­ï¼Œå½“çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ï¼Œåªä¼šæ›´æ–°éœ€è¦æ›´æ–°çš„éƒ¨åˆ†ï¼Œè€Œä¸æ˜¯æ•´ä¸ªç»„ä»¶ã€‚åœ¨ Vue ä¸­ï¼Œç»†ç²’åº¦æ›´æ–°ä½“ç°åœ¨ `watch` ä»¥åŠ `computed` ä¸­ã€‚

ä¸€ä¸ªæœ€ä¸ºå…¸å‹çš„ä¾‹å­å¦‚ä¸‹ï¼š

```jsx
import React, { useState, useEffect } from 'react';

export function Example1(){
  const [count, setCount] = useState(0);
  useEffect(()=>{
    if (count > 10){
      setCount(0);
    }
  }, [count]);
  return (
    <div>
        {count}
        <button onClick={() => setCount(count + 1)}>+</button>
    </div>
  )
}
```

export function Example1 () {
  const [count, setCount] = useState(0)
  useEffect(() => {
    if (count > 10) {
      setCount(0)
    }
  }, [count])
  return (
    <div className={'flex h-max'}>
      {count}
      <button className={'ml-5 h-5 text-blue-500 flex items-center justify-center text-center text-2xl'} onClick={() => setCount(count + 1)}>+</button>
    </div>
  )
}

<Exb>
<Example1 />
</Exb>

åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ `useState` å’Œ `useEffect` æ¥å®ç°ä¸€ä¸ªè®¡æ•°å™¨ï¼Œå½“è®¡æ•°å™¨çš„å€¼å¤§äº 10 æ—¶ï¼Œé‡ç½®ä¸º 0ã€‚åœ¨è¿™é‡Œå‰¯ä½œç”¨æœ‰ä¸€ä¸ªä¾èµ– `count`ï¼Œå½“ `count` å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå‰¯ä½œç”¨ä¼šé‡æ–°æ‰§è¡Œã€‚åœ¨è¿™é‡Œï¼Œå½“ `count` å‘ç”Ÿå˜åŒ–æ—¶ï¼Œåªæœ‰è®¡æ•°å™¨çš„å€¼å‘ç”Ÿäº†å˜åŒ–ï¼Œè€Œä¸æ˜¯æ•´ä¸ªç»„ä»¶ã€‚é‚£ä¹ˆè®©æˆ‘ä»¬æ¥å®ç°ä¸€ä¸ªç®€å•çš„å®ä¾‹ï¼Œå®ç°ç»†ç²’åº¦æ›´æ–°ã€‚

## è®¢é˜…å‘å¸ƒæ¨¡å¼

åœ¨å®ç°ç»†ç²’åº¦æ›´æ–°çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å®ç°ä¸€ä¸ªè®¢é˜…å‘å¸ƒæ¨¡å¼ï¼Œè®¢é˜…å‘å¸ƒæ¨¡å¼æ˜¯ä¸€ç§è®¾è®¡æ¨¡å¼ï¼Œå®ƒå®šä¹‰äº†ä¸€ç§ä¸€å¯¹å¤šçš„ä¾èµ–å…³ç³»ï¼Œè®©å¤šä¸ªè§‚å¯Ÿè€…å¯¹è±¡åŒæ—¶ç›‘å¬æŸä¸€ä¸ªä¸»é¢˜å¯¹è±¡ï¼Œè¿™ä¸ªä¸»é¢˜å¯¹è±¡çš„çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ï¼Œä¼šé€šçŸ¥æ‰€æœ‰è§‚å¯Ÿè€…å¯¹è±¡ï¼Œä½¿å®ƒä»¬èƒ½å¤Ÿè‡ªåŠ¨æ›´æ–°è‡ªå·±ã€‚

å‘å¸ƒè®¢é˜…æ¨¡å¼æ˜¯ä¸€ç§å®šä¹‰å¯¹è±¡é—´ä¸€å¯¹å¤šçš„ä¾èµ–å…³ç³»çš„è®¾è®¡æ¨¡å¼ï¼Œå½“ä¸€ä¸ªå¯¹è±¡çš„çŠ¶æ€å‘ç”Ÿæ”¹å˜æ—¶ï¼Œæ‰€æœ‰ä¾èµ–äºå®ƒçš„å¯¹è±¡éƒ½å°†å¾—åˆ°é€šçŸ¥ã€‚åœ¨ JavaScript ä¸­ï¼Œå‘å¸ƒè®¢é˜…æ¨¡å¼åˆè¢«ç§°ä¸ºè§‚å¯Ÿè€…æ¨¡å¼ã€‚å®ƒå¯ä»¥å¹¿æ³›åº”ç”¨äºå¼‚æ­¥ç¼–ç¨‹ä¸­ï¼Œè¿™æ˜¯ä¸€ç§æ›¿ä»£ä¼ é€’å›è°ƒå‡½æ•°çš„æ–¹æ¡ˆã€‚æ¯”å¦‚ï¼Œå¯ä»¥è®¢é˜… ajax è¯·æ±‚çš„ errorã€succ ç­‰äº‹ä»¶ã€‚æ— éœ€è¿‡å¤šå…³æ³¨å¯¹è±¡åœ¨å¼‚æ­¥è¿è¡ŒæœŸé—´çš„å†…éƒ¨çŠ¶æ€ï¼Œè€Œåªéœ€è¦è®¢é˜…æ„Ÿå…´è¶£çš„äº‹ä»¶å‘ç”Ÿç‚¹ã€‚

## `useState`

`useState` ç”¨äºå­˜å‚¨ä¸€ä¸ªçŠ¶æ€ï¼Œå½“è¿™ä¸ªçŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå®ƒä¼šç‰µåŠ¨ UI æ¸²æŸ“å‘ç”Ÿå˜åŒ–ï¼Œä»¥åŠä¸ä¹‹ç›¸å…³çš„å‰¯ä½œç”¨å‘ç”Ÿå˜åŒ–ã€‚åœ¨ `useState` ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ä¼ å…¥ä¸€ä¸ªåˆå§‹å€¼ï¼Œå®ƒä¼šè¿”å›ä¸€ä¸ªæ•°ç»„ï¼Œç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯å½“å‰çš„çŠ¶æ€ï¼Œç¬¬äºŒä¸ªå…ƒç´ æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œç”¨äºæ›´æ–°çŠ¶æ€ã€‚

åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä½¿ç”¨ `myUseState` æ¥å®ç°ä¸€ä¸ªç®€å•çš„ `useState`ï¼Œå®ƒæ¥æ”¶ä¸€ä¸ªåˆå§‹å€¼ï¼Œè¿”å›ä¸€ä¸ªæ•°ç»„ï¼Œç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯å½“å‰çš„çŠ¶æ€ï¼Œç¬¬äºŒä¸ªå…ƒç´ æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œç”¨äºæ›´æ–°çŠ¶æ€ã€‚

```jsx {6}
function myUseState(initialValue){
  const getter = () => initialValue;
  const setter = (newValue) => {
      initialValue = newValue;
  }
  return [getter, setter];
}
```

export function Example2 () {
  function myUseState (initialValue) {
    const getter = () => initialValue
    const setter = (newValue) => {
      console.log(newValue)
      initialValue = newValue
    }
    return [getter, setter]
  }
  const [count, setCount] = myUseState(0)
  return (
    <div className={'flex h-max'}>
      <button className={'ml-5 h-5 text-blue-500 flex items-center justify-center text-center text-2xl'} onClick={() => setCount(count() + 1)}>+</button>
    </div>
  )
}

ä½¿ç”¨ç¤ºä¾‹å¦‚ä¸‹ï¼Œä½†æ˜¯ä½ ä¼šå‘ç°ç‚¹å‡»åï¼Œè®¡æ•°å™¨çš„å€¼å¹¶æ²¡æœ‰å‘ç”Ÿå˜åŒ–ã€‚è¿™æ˜¯å› ä¸ºè¿™éœ€è¦æ›´æ–° UI ï¼Œè€Œæˆ‘ä»¬è¿™é‡Œåªæ˜¯æ›´æ–°äº†çŠ¶æ€ï¼Œæ‰€ä»¥ä½ å¯ä»¥åœ¨æ§åˆ¶å°ä¸­çœ‹åˆ°çŠ¶æ€çš„å˜åŒ–ã€‚

<Exb>
<Example2 />
</Exb>

<Callout type="info" emoji="â„¹ï¸">
  å¤ä¹ ï¼šä»€ä¹ˆæ˜¯é—­åŒ…ï¼Ÿé—­åŒ…æ˜¯æŒ‡æœ‰æƒè®¿é—®å¦ä¸€ä¸ªå‡½æ•°ä½œç”¨åŸŸä¸­çš„å˜é‡çš„å‡½æ•°ã€‚åˆ›å»ºé—­åŒ…çš„å¸¸è§æ–¹å¼ï¼Œå°±æ˜¯åœ¨ä¸€ä¸ªå‡½æ•°å†…éƒ¨åˆ›å»ºå¦ä¸€ä¸ªå‡½æ•°ã€‚
</Callout>

è¿™é‡Œæˆ‘ä»¬å®šä¹‰äº†ä¸¤ä¸ªå‡½æ•°ï¼Œ`getter` ç”¨äºå–å€¼ï¼Œ`setter` ç”¨äºæ›´æ–°å€¼ï¼Œæˆ‘ä»¬å°†è¿™ä¸¤ä¸ªå‡½æ•°è¿”å›ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨å¤–éƒ¨ä½¿ç”¨ `getter` å’Œ `setter` æ¥è·å–å’Œæ›´æ–°çŠ¶æ€ã€‚è¿™é‡Œå®é™…ä¸Šå½¢æˆäº†ä¸€ä¸ªé—­åŒ…å‡½æ•°ã€‚æ³¨æ„è¿™é‡Œä¸ React æœ‰ä¸€ç‚¹ä¸åŒï¼Œæˆ‘ä»¬è¿”å›çš„æ•°ç»„ç¬¬ä¸€ä¸ªå…ƒç´ å¹¶ä¸æ˜¯å€¼ï¼Œè€Œæ˜¯ getter ï¼Œè¿™åœ¨åé¢ä¼šæåˆ°ã€‚

## `useEffect`

æ¥ä¸‹æ¥æˆ‘ä»¬å®ç° `useEffect`ï¼Œå®ƒç”¨äºæ‰§è¡Œå‰¯ä½œç”¨ï¼Œå½“ä¾èµ–å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå®ƒä¼šé‡æ–°æ‰§è¡Œã€‚ä»–çš„è¡Œä¸ºæ˜¯ï¼š

- useEffect æ‰§è¡Œåï¼Œå›è°ƒå‡½æ•°ç«‹åˆ»æ‰§è¡Œã€‚
- ä¾èµ–çš„è‡ªå˜é‡å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå›è°ƒå‡½æ•°ä¼šé‡æ–°æ‰§è¡Œã€‚
- ä¸éœ€è¦æ˜¾å¼æŒ‡æ˜ä¾èµ–ã€‚

å¦‚ï¼š

```jsx
const [count, setCount] = myUseState(0);

useEffect(() => {
  console.log('count changed'+count()); // è‡ªåŠ¨ä¾èµ– count
});

useEffect(() => {
  console.log('ä½ å¥½å‘€'); // ä¸ä¾èµ–ä»»ä½•å˜é‡ï¼Œå› æ­¤ count å˜åŒ–æ—¶ä¸ä¼šæ‰§è¡Œ
});

setCount(1);
```
å®ç°çš„å…³é”®åœ¨äºå»ºç«‹ myUseState ä¸ myUseState ä¹‹é—´çš„è®¢é˜…å‘å¸ƒå…³ç³»ã€‚æˆ‘ä»¬åœ¨ myUseState ä¸­ç»´æŠ¤ä¸€ä¸ªè®¢é˜…è€…åˆ—è¡¨ï¼Œæ¥ä¿å­˜è®¢é˜…è¿™ä¸ª state å˜åŒ–çš„ effectã€‚effect æœ‰ä¸‹é¢çš„æ•°æ®ç»“æ„ï¼š

```jsx
const effect = {
  // effect çš„å›è°ƒå‡½æ•°
  execute,
  // ä¿å­˜è¯¥ useEffect ä¾èµ–çš„ state çš„å¯¹åº” subs çš„é›†åˆ
  deps: new Set(),
}
```
è¿™é‡Œè®©æˆ‘ä»¬å…³æ³¨ä¸¤ä¸ªä¸œè¥¿ï¼Œä¸€ä¸ªæ˜¯ `execute`ï¼Œå®ƒæ˜¯ effect çš„å›è°ƒå‡½æ•°ï¼Œå¦ä¸€ä¸ªæ˜¯ `deps`ï¼Œå®ƒæ˜¯ä¸€ä¸ªé›†åˆï¼Œç”¨äºä¿å­˜è¯¥ effect ä¾èµ–çš„ state çš„å¯¹åº” subs çš„é›†åˆã€‚

`Set()` æ˜¯ ES6 ä¸­æ–°å¢çš„æ•°æ®ç»“æ„ï¼Œå®ƒç±»ä¼¼äºæ•°ç»„ï¼Œä½†æ˜¯æˆå‘˜çš„å€¼éƒ½æ˜¯å”¯ä¸€çš„ï¼Œæ²¡æœ‰é‡å¤çš„å€¼ã€‚å®ƒæœ‰ä»¥ä¸‹çš„æ–¹æ³•ï¼š

- `add(value)`ï¼šæ·»åŠ æŸä¸ªå€¼ï¼Œè¿”å› Set ç»“æ„æœ¬èº«ã€‚
- `delete(value)`ï¼šåˆ é™¤æŸä¸ªå€¼ï¼Œè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºåˆ é™¤æ˜¯å¦æˆåŠŸã€‚
- `has(value)`ï¼šè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºè¯¥å€¼æ˜¯å¦ä¸º Set çš„æˆå‘˜ã€‚
- `clear()`ï¼šæ¸…é™¤æ‰€æœ‰æˆå‘˜ï¼Œæ²¡æœ‰è¿”å›å€¼ã€‚
- ...

```js
let mySet = new Set();

mySet.add(1); // Set [ 1 ]
mySet.add(5); // Set [ 1, 5 ]
mySet.add(5); // Set [ 1, 5 ]
mySet.add("some text"); // Set [ 1, 5, "some text" ]
let o = {a: 1, b: 2};
mySet.add(o);

mySet.add({a: 1, b: 2}); // o æŒ‡å‘çš„æ˜¯ä¸åŒçš„å¯¹è±¡ï¼Œæ‰€ä»¥æ²¡é—®é¢˜

mySet.has(1); // true
mySet.has(3); // false
mySet.has(5);              // true
mySet.has(Math.sqrt(25));  // true
mySet.has("Some Text".toLowerCase()); // true
mySet.has(o); // true

mySet.size; // 5

mySet.delete(5);  // trueï¼Œä» set ä¸­ç§»é™¤ 5
mySet.has(5);     // false, 5 å·²ç»è¢«ç§»é™¤

mySet.size; // 4ï¼Œåˆšåˆšç§»é™¤ä¸€ä¸ªå€¼

console.log(mySet);
// logs Set(4) [ 1, "some text", {â€¦}, {â€¦} ] in Firefox
// logs Set(4) { 1, "some text", {â€¦}, {â€¦} } in Chrome
```

å‚è€ƒ [MDN SetğŸ–±](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Set)

é€šè¿‡éå† state.subs å¯ä»¥æ‰¾åˆ°æ‰€æœ‰è®¢é˜…è¿™ä¸ª state å˜åŒ–çš„ effectï¼Œç„¶åå°†éå† effect.deps å¯ä»¥æ‰¾åˆ°æ‰€æœ‰è¯¥ effect ä¾èµ–çš„ stateï¼Œç„¶åå°† effect æ·»åŠ åˆ°è¿™äº› state çš„ subs ä¸­ã€‚

```jsx
function myUseEffect (callback) {
  const execute = () => {
    // é‡ç½®ä¾èµ–
    cleanup(effect);
    // å°†å½“å‰ effect æ¨åˆ°æ ˆé¡¶
    effectStack.push(effect);
    try {
      // æ‰§è¡Œå›è°ƒå‡½æ•°
      callback();
    } finally {
      // å°†å½“å‰ effect ä»æ ˆé¡¶å¼¹å‡º
      effectStack.pop();
    }
  }
  const effect = {
    execute,
    deps: new Set(),
  }
  // ç«‹å³æ‰§è¡Œä¸€æ¬¡ï¼Œå»ºç«‹è®¢é˜…å‘å¸ƒå…³ç³»ï¼Œå› ä¸ºåœ¨ç¬¬ä¸€æ¬¡æ¸²æŸ“ä¹‹åï¼Œæˆ‘ä»¬éœ€è¦æ‰§è¡Œä¸€æ¬¡ effect
  execute();
}
```

æ¯ä¸ª Effect å¯¹è±¡éƒ½ç”±ä¸€ä¸ªå›è°ƒå‡½æ•°å’Œä¸€äº›ä¾èµ–ç»„æˆï¼Œå½“ä¾èµ–å‘ç”Ÿå˜åŒ–æ—¶ï¼Œæˆ‘ä»¬éœ€è¦é‡æ–°æ‰§è¡Œå›è°ƒå‡½æ•°ã€‚å› æ­¤æˆ‘ä»¬å®šä¹‰äº† Effect å¯¹è±¡ã€‚æˆ‘ä»¬æŠŠ Effect å¯¹è±¡æ”¾åˆ°ä¸€ä¸ªæ ˆä¸­ï¼Œæ­£åœ¨æ‰§è¡Œçš„ Effect å¯¹è±¡å°±æ˜¯æ ˆé¡¶çš„ Effect å¯¹è±¡ã€‚å½“æˆ‘ä»¬æ‰§è¡Œå›è°ƒå‡½æ•°æ—¶ï¼Œæˆ‘ä»¬éœ€è¦å°†å½“å‰çš„ Effect å¯¹è±¡æ¨åˆ°æ ˆé¡¶ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡æ ˆé¡¶çš„ Effect å¯¹è±¡æ¥è·å–ä¾èµ–çš„ stateï¼Œç„¶åå°†å½“å‰çš„ Effect å¯¹è±¡æ·»åŠ åˆ°è¿™äº› state çš„ subs ä¸­ã€‚å¯ä»¥æŠŠ effect æƒ³è±¡æˆä¸€ä¸ªç›’å­ï¼Œé‡Œé¢è£…ç€ä¸€ä¸ªä»»åŠ¡å’Œä¸€äº›æ ‡ç­¾ã€‚ä»»åŠ¡å°±æ˜¯å›è°ƒå‡½æ•°ï¼Œæ ‡ç­¾å°±æ˜¯ä¾èµ–ã€‚æ¯æ¬¡æ¸²æŸ“åï¼Œä½ éœ€è¦æ£€æŸ¥ç›’å­çš„æ ‡ç­¾æ˜¯å¦æœ‰å˜åŒ–ï¼Œå¦‚æœæœ‰å˜åŒ–ï¼Œå°±è¦é‡æ–°æ‰§è¡Œç›’å­é‡Œçš„ä»»åŠ¡ã€‚ä¸ºäº†æ–¹ä¾¿æ£€æŸ¥æ ‡ç­¾ï¼Œä½ éœ€è¦åœ¨ç¬¬ä¸€æ¬¡æ¸²æŸ“åï¼ŒæŠŠç›’å­æ”¾åˆ°ä¸€ä¸ªæ ˆé‡Œï¼Œè¿™æ ·ä½ å°±çŸ¥é“å½“å‰æœ‰å“ªäº›ç›’å­ã€‚è€Œåœ¨æ”¶é›†æ ‡ç­¾çš„æ—¶å€™ï¼Œä½ éœ€è¦çŸ¥é“å½“å‰æ­£åœ¨å¤„ç†å“ªä¸ªç›’å­ï¼Œè¿™æ ·æ‰èƒ½æŠŠæ ‡ç­¾è´´åˆ°æ­£ç¡®çš„ç›’å­ä¸Šã€‚è€Œå½“å‰æ­£åœ¨å¤„ç†çš„ç›’å­ï¼Œå°±æ˜¯æ ˆé¡¶çš„é‚£ä¸ªã€‚

è¿™é‡Œåœ¨æ‰§è¡Œå›è°ƒå‡½æ•°å‰æˆ‘ä»¬ä½¿ç”¨ cleanup å‡½æ•°æ¥é‡ç½®ä¾èµ–ï¼Œè¿™æ˜¯å› ä¸ºå½“ä¾èµ–å‘ç”Ÿå˜åŒ–æ—¶ï¼Œæˆ‘ä»¬éœ€è¦å°† effect ä»åŸæ¥çš„ state çš„ subs ä¸­ç§»é™¤ï¼Œç„¶åå†æ·»åŠ åˆ°æ–°çš„ state çš„ subs ä¸­ã€‚è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ `Set` æ¥ä¿å­˜ä¾èµ–ï¼Œå› ä¸º `Set` ä¸­çš„æˆå‘˜æ˜¯å”¯ä¸€çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡ `Set` æ¥åˆ¤æ–­ä¾èµ–æ˜¯å¦å‘ç”Ÿå˜åŒ–ã€‚ä¸ºä»€ä¹ˆè¦åœ¨æ‰§è¡Œå›è°ƒå‡½æ•°å‰é‡ç½®ä¾èµ–å‘¢ï¼Ÿè¿™å°†åœ¨åé¢æ­æ™“ã€‚

```jsx filename="cleanup.js"
function cleanup (effect) {
  // ä»è¯¥ effect ä¾èµ–çš„ state çš„ subs ä¸­ç§»é™¤è¯¥ effect
  for (const state of effect.deps) {
    state.delete(effect);  // delete æ˜¯ Set çš„æ–¹æ³•
  }
  // æ¸…ç©ºè¯¥ effect ä¾èµ–çš„ state çš„é›†åˆ
  effect.deps.clear();  // clear æ˜¯ Set çš„æ–¹æ³•
}
```

æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦åœ¨ myUseState ä¸­ç»´æŠ¤ä¸€ä¸ªè®¢é˜…è€…åˆ—è¡¨ï¼Œæ¥ä¿å­˜è®¢é˜…è¿™ä¸ª state å˜åŒ–çš„ effectã€‚

```jsx filename="myUseState.js"
function myUseState (value) {
  const subs = new Set();

  const getter = () => {
    // è·å–ä¸Šä¸‹æ–‡çš„ effect
    const effect = effectStack[effectStack.length - 1]; // å–æ ˆé¡¶
    if (effect) {
      subscribe(effect, subs);  // å»ºç«‹è®¢é˜…å‘å¸ƒå…³ç³»
    }
    return value;
  }

  const setter = (newValue) => {
    value = newValue;
    // æ‰§è¡Œæ‰€æœ‰è®¢é˜…è€…çš„å›è°ƒå‡½æ•°
    for (const effect of [...subs]) {
      effect.execute(); // æ‰§è¡Œ effect çš„å›è°ƒå‡½æ•°
    }
  }

  return [getter, setter];
}
```
è·å–ä¸Šä¸‹æ–‡çš„ effect å¹¶å»ºç«‹è®¢é˜…å‘å¸ƒå…³ç³»ï¼Œæ˜¯ä¸ºäº†å®ç°çŠ¶æ€å’Œå‰¯ä½œç”¨çš„åŒæ­¥ã€‚**å¦‚æœä¸€ä¸ª effect ä½¿ç”¨äº†ä¸€ä¸ªçŠ¶æ€ï¼Œé‚£ä¹ˆè¿™ä¸ª effect å°±åº”è¯¥åœ¨è¿™ä¸ªçŠ¶æ€å˜åŒ–æ—¶é‡æ–°æ‰§è¡Œï¼Œä»¥ä¿è¯å‰¯ä½œç”¨çš„æ­£ç¡®æ€§**ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä¸€ä¸ª effect æ˜¯æ‰“å°ä¸€ä¸ªçŠ¶æ€çš„å€¼ï¼Œé‚£ä¹ˆè¿™ä¸ª effect å°±åº”è¯¥åœ¨è¿™ä¸ªçŠ¶æ€å˜åŒ–æ—¶é‡æ–°æ‰“å°ï¼Œä»¥ä¿è¯æ‰“å°çš„å€¼æ˜¯æœ€æ–°çš„ã€‚ä¸ºäº†å®ç°è¿™ä¸ªåŠŸèƒ½ï¼Œå°±éœ€è¦åœ¨çŠ¶æ€å’Œ effect ä¹‹é—´å»ºç«‹è®¢é˜…å‘å¸ƒå…³ç³»ï¼Œè¿™æ ·å½“çŠ¶æ€å˜åŒ–æ—¶ï¼Œå°±å¯ä»¥é€šçŸ¥æ‰€æœ‰è®¢é˜…äº†è¿™ä¸ªçŠ¶æ€çš„ effectï¼Œè®©å®ƒä»¬é‡æ–°æ‰§è¡Œã€‚

ä¸Šé¢çš„è¿™äº›è¯æœ‰ç‚¹ç»•ï¼Œè®©æˆ‘ä»¬çœ‹ä¸€ä¸ªä¾‹å­ï¼š

```jsx
// å‡è®¾æœ‰ä¸€ä¸ªè‡ªå®šä¹‰çš„ useState å‡½æ•°ï¼Œè¿”å›ä¸€ä¸ªçŠ¶æ€å€¼å’Œä¸€ä¸ªæ›´æ–°çŠ¶æ€çš„å‡½æ•°
const [count, setCount] = myUseState(0);

// å‡è®¾æœ‰ä¸€ä¸ªè‡ªå®šä¹‰çš„ useEffect å‡½æ•°ï¼Œæ¥å—ä¸€ä¸ªå›è°ƒå‡½æ•°
myUseEffect(() => {
  // åœ¨å›è°ƒå‡½æ•°ä¸­ï¼Œæ‰“å°çŠ¶æ€å€¼
  console.log(count());
});

// è¿™ä¸ªä¾‹å­çš„å†…éƒ¨è¿‡ç¨‹å¦‚ä¸‹ï¼š

// é¦–å…ˆï¼Œè°ƒç”¨ myUseState(0)ï¼Œåˆ›å»ºä¸€ä¸ªçŠ¶æ€å€¼ä¸º 0 çš„çŠ¶æ€
// åˆ›å»ºä¸€ä¸ª subs é›†åˆï¼Œç”¨äºå­˜å‚¨è®¢é˜…äº†è¿™ä¸ªçŠ¶æ€çš„ effect
// åˆ›å»ºä¸€ä¸ª getter å‡½æ•°ï¼Œç”¨äºè·å–çŠ¶æ€å€¼
// åˆ›å»ºä¸€ä¸ª setter å‡½æ•°ï¼Œç”¨äºæ›´æ–°çŠ¶æ€å€¼
// è¿”å› getter å’Œ setter å‡½æ•°

// ç„¶åï¼Œè°ƒç”¨ myUseEffect(() => {console.log(count());})ï¼Œåˆ›å»ºä¸€ä¸ª effect
// åˆ›å»ºä¸€ä¸ª execute å‡½æ•°ï¼Œç”¨äºæ‰§è¡Œå›è°ƒå‡½æ•°
// åˆ›å»ºä¸€ä¸ª effect å¯¹è±¡ï¼ŒåŒ…å« execute å‡½æ•°å’Œä¸€ä¸ªå­˜å‚¨ä¾èµ–çš„é›†åˆ
// è°ƒç”¨ execute å‡½æ•°

// åœ¨ execute å‡½æ•°ä¸­ï¼Œå…ˆé‡ç½®ä¾èµ–ï¼Œç„¶åå°†å½“å‰çš„ effect å¯¹è±¡æ¨åˆ°ä¸€ä¸ªæ ˆä¸­
// ç„¶åæ‰§è¡Œå›è°ƒå‡½æ•°ï¼Œåœ¨å›è°ƒå‡½æ•°ä¸­ï¼Œæ‰“å°çŠ¶æ€å€¼
// åœ¨æ‰“å°çŠ¶æ€å€¼æ—¶ï¼Œè°ƒç”¨ getter å‡½æ•°ï¼Œè·å–çŠ¶æ€å€¼
// åœ¨è·å–çŠ¶æ€å€¼æ—¶ï¼Œå¦‚æœå­˜åœ¨å½“å‰æ­£åœ¨å¤„ç†çš„ effectï¼Œå°±å°†è¿™ä¸ª effect æ·»åŠ åˆ° subs é›†åˆä¸­ï¼Œå»ºç«‹è®¢é˜…å…³ç³»ï¼Œå› ä¸ºè¿™ä¸ª effect ä¾èµ–äº†è¿™ä¸ªçŠ¶æ€
// æœ€åå°† effect å¯¹è±¡ä»æ ˆä¸­å¼¹å‡º

// è¿™æ ·ï¼Œå½“çŠ¶æ€å€¼å˜åŒ–æ—¶ï¼Œå°±å¯ä»¥é€šè¿‡ setter å‡½æ•°æ›´æ–°çŠ¶æ€å€¼ï¼Œå¹¶é€šçŸ¥æ‰€æœ‰è®¢é˜…äº†è¿™ä¸ªçŠ¶æ€çš„ effectï¼Œè®©å®ƒä»¬é‡æ–°æ‰§è¡Œå›è°ƒå‡½æ•°ï¼Œæ‰“å°æœ€æ–°çš„çŠ¶æ€å€¼
```
![](https://jetzihan-img.oss-cn-beijing.aliyuncs.com/blog/mermaid-diagram-2023-04-05-145725.svg)

## subscribe

æ¥ä¸‹æ¥æˆ‘ä»¬æ¥å®ç° subscribe å‡½æ•°ï¼Œå®ƒçš„ä½œç”¨æ˜¯å»ºç«‹è®¢é˜…å…³ç³»ã€‚

```jsx filename="subscribe"
function subscribe (effect, subs) {
    // è®¢é˜…å…³ç³»å»ºç«‹
    subs.add(effect); // å°† effect æ·»åŠ åˆ° state çš„ subs ä¸­
    // å°† effect ä¾èµ–çš„ state æ·»åŠ åˆ° effect çš„ deps ä¸­
    effect.deps.add(subs);
}
```
## `useMemo`

`useMemo` ç”¨äºç¼“å­˜ä¸€ä¸ªå€¼ï¼Œå½“ä¾èµ–å‘ç”Ÿå˜åŒ–æ—¶ï¼Œæ‰ä¼šé‡æ–°è®¡ç®—è¿™ä¸ªå€¼ã€‚å®ƒçš„å®ç°ä¹Ÿå¾ˆç®€å•ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨ `useMemo` ä¸­ç»´æŠ¤ä¸€ä¸ªç¼“å­˜å¯¹è±¡ï¼Œå½“ä¾èµ–å‘ç”Ÿå˜åŒ–æ—¶ï¼Œæ‰ä¼šé‡æ–°è®¡ç®—è¿™ä¸ªå€¼ã€‚

```jsx filename="myUseMemo.js"
function myUseMemo (callback) {
  const [s, set] = myUseState()
  // é¦–æ¬¡æ‰§è¡Œ callbackï¼Œå»ºç«‹å›è°ƒä¸­ state çš„è®¢é˜…å‘å¸ƒå…³ç³»
  myUseEffect(() => {
    set(callback())
  })
  return s
}
```
ä½¿ç”¨ `useMemo` çš„ä¾‹å­ï¼š

```jsx
const [count, setCount] = myUseState(0);

const memoizedValue = myUseMemo(() => {
  return count() * 2;
});

myUseEffect(() => {
  console.log(memoizedValue());
});
```
å®ƒçš„ä½œç”¨æ˜¯ï¼Œå½“ count å˜åŒ–æ—¶ï¼Œæ‰ä¼šé‡æ–°è®¡ç®— memoizedValue çš„å€¼ã€‚

æˆ‘ä»¬çœ‹ä¸€ä¸ªå…³äºä½¿ç”¨ useMyEffect ã€useMyState å’Œ useMyMemo çš„ä¾‹å­ï¼š

```jsx
export default function App() {
  const [count, setCount] = myUseState(0);
  const [name, setName] = myUseState('Jet');

  const memoizedValue = myUseMemo(() => {
    return count() * 2;
  });

  myUseEffect(() => {
    console.log(memoizedValue());
  });

  return (
    <div>
      <p>You clicked {count()} times</p>
      <button onClick={() => setCount(count() + 1)}>
        Click me
      </button>
      <p>My name is {name()}</p>
      <button onClick={() => setName('JeLlab')}>
        Change name
      </button>
    </div>
  );
}
```

## ä¸ºä»€ä¹ˆéœ€è¦é‡ç½®è®¢é˜…å‘å¸ƒå…³ç³»ï¼Ÿ

åœ¨ä¹‹å‰çš„ä»£ç ä¸­ï¼Œæˆ‘ä¹ˆåœ¨æ¯æ¬¡ effect.execute() æ—¶ï¼Œéƒ½ä¼šé‡ç½® effect.depsï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ

è€ƒè™‘ä¸‹é¢çš„ä¾‹å­ï¼š

```jsx
const [name1, setName1] = myUseState('Jet');
const [name2, setName2] = myUseState('JeLlab');
const [showAll, setShowAll] = myUseState(true);

const whoIsHere = useMemo(() => {
  return showAll() ? `${name1()} and ${name2()}` : name1();
});

useEffect(() => {
  console.log(whoIsHere()); // åˆå§‹åŒ–æ—¶ï¼Œæ‰“å° 'Jet and JeLlab'
});
```

åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œ`whoIsHere` ä¾èµ–äº `name1` å’Œ `name2`ï¼Œå½“ `name1` æˆ– `name2` å‘ç”Ÿå˜åŒ–æ—¶ï¼Œ`whoIsHere` éƒ½ä¼šå‘ç”Ÿå˜åŒ–, `whoIsHere` å®é™…ä¸Šæ˜¯ä¸€ä¸ªæ— å‰¯ä½œç”¨çš„å› å˜é‡ï¼Œï¼Œæ¥ä¸‹æ¥æ‰§è¡Œä¸‹é¢çš„ä»£ç ï¼š

```jsx
setName1('Jet2'); // è§¦å‘ effectï¼Œæ‰“å° 'Jet2 and JeLlab'

setShowAll(false); // è§¦å‘ effectï¼Œæ‰“å° 'Jet2'

setName2('JeLlab2'); // ä¸æ‰“å°
```

å½“ setShowAll å˜ä¸º false æ—¶ï¼ŒwhoIsHere æ‰§è¡Œ `name1()`ï¼Œç”±äº `name2()` æ²¡æœ‰è¢«æ‰§è¡Œï¼Œå› æ­¤ `name2()` ä¸ whoIsHere æ²¡æœ‰è®¢é˜…å…³ç³»ï¼Œæ‰€ä»¥ `name2()` å‘ç”Ÿå˜åŒ–æ—¶ï¼Œä¸ä¼šè§¦å‘ `whoIsHere` çš„é‡æ–°è®¡ç®—ã€‚åªæœ‰åœ¨å†æ¬¡ä¿®æ”¹ `showAll` ä¸º true æ—¶ï¼Œ`whoIsHere` æ‰ä¼šé‡æ–°è®¡ç®—ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦é‡ç½®è®¢é˜…å‘å¸ƒå…³ç³»ã€‚å®ƒçš„æ„ä¹‰åœ¨äºï¼Œå½“ effect æ‰§è¡Œæ—¶ï¼Œåªä¼šè®¢é˜… effect ä¸­ä½¿ç”¨åˆ°çš„ stateï¼Œè€Œä¸ä¼šè®¢é˜… effect ä¹‹å‰ä½¿ç”¨è¿‡çš„ stateã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆå°½ç®¡åœ¨ `name2()` æ›¾ç»è¢« `whoIsHere` ä¾èµ–è¿‡ï¼Œä½†æ˜¯å½“ `name2()` ä¸è¢« `whoIsHere` ä¾èµ–æ—¶ï¼Œ`name2()` å‘ç”Ÿå˜åŒ–æ—¶ï¼Œä¸ä¼šè§¦å‘ `whoIsHere` çš„é‡æ–°è®¡ç®—ã€‚

## æ€»ç»“

åœ¨è¿™é‡Œæˆ‘ä»¬å®ç°çš„ç»†ç²’åº¦æ›´æ–°ï¼Œå®ƒæ— éœ€æ˜¾å¼æŒ‡æ˜ä¾èµ–ã€‚æ›´åŠ ç®€æ´ï¼Œä¹Ÿæ›´åŠ ç›´è§‚ã€‚ä½†æ˜¯ React æœ¬èº«ä¸ºä»€ä¹ˆä¸é‡‡ç”¨è¿™ç§æ–¹å¼å‘¢ï¼Ÿå› ä¸º React ä½œä¸ºä¸€ä¸ªåº”ç”¨çº§æ¡†æ¶ï¼Œä¸éœ€è¦è¿‡å¤šçš„å…³æ³¨ç»†ç²’åº¦çš„æ›´æ–°ã€‚

åŒ…å«åº•å±‚å®ç°çš„å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š

```jsx filename="myReact.js"
export function Example4 () {

  const effectStack = []

  function subscribe (effect, subs) {
    // è®¢é˜…å…³ç³»å»ºç«‹
    subs.add(effect) // å°† effect æ·»åŠ åˆ° state çš„ subs ä¸­
    // å°† effect ä¾èµ–çš„ state æ·»åŠ åˆ° effect çš„ deps ä¸­
    effect.deps.add(subs)
  }

  function myUseMemo (callback) {
    const [s, set] = myUseState()
    // é¦–æ¬¡æ‰§è¡Œ callbackï¼Œå»ºç«‹å›è°ƒä¸­ state çš„è®¢é˜…å‘å¸ƒå…³ç³»
    myUseEffect(() => {
      set(callback())
    })
    return s
  }

  function myUseState (value) {
    const subs = new Set()  // ç”¨äºå­˜æ”¾è®¢é˜…è€…çš„é›†åˆ

    const getter = () => {
      // è·å–ä¸Šä¸‹æ–‡çš„ effect
      const effect = effectStack[effectStack.length - 1] // å–æ ˆé¡¶
      if (effect) {
        subscribe(effect, subs) // å»ºç«‹è®¢é˜…å‘å¸ƒå…³ç³»
      }
      return value
    }

    const setter = (newValue) => {
      value = newValue
      // æ‰§è¡Œæ‰€æœ‰è®¢é˜…è€…çš„å›è°ƒå‡½æ•°
      for (const effect of [...subs]) {
        effect.execute() // æ‰§è¡Œ effect çš„å›è°ƒå‡½æ•°
      }
    }

    return [getter, setter]
  }

  function cleanup (effect) {
    // ä»è¯¥ effect ä¾èµ–çš„ state çš„ subs ä¸­ç§»é™¤è¯¥ effect
    for (const subs of effect.deps) {
      subs.delete(effect) // delete æ˜¯ Set çš„æ–¹æ³•
    }
    // æ¸…ç©ºè¯¥ effect ä¾èµ–çš„ state çš„é›†åˆ
    effect.deps.clear() // clear æ˜¯ Set çš„æ–¹æ³•
  }

  function myUseEffect (callback) {
    const execute = () => {
      // é‡ç½®ä¾èµ–
      cleanup(effect)
      // å°†å½“å‰ effect æ¨åˆ°æ ˆé¡¶
      effectStack.push(effect)
      try {
        // æ‰§è¡Œå›è°ƒå‡½æ•°
        callback()
      } finally {
        // å°†å½“å‰ effect ä»æ ˆé¡¶å¼¹å‡º
        effectStack.pop()
      }
    }
    const effect = {
      execute,
      deps: new Set()
    }
    // ç«‹å³æ‰§è¡Œä¸€æ¬¡ï¼Œå»ºç«‹è®¢é˜…å‘å¸ƒå…³ç³»ï¼Œå› ä¸ºåœ¨ç¬¬ä¸€æ¬¡æ¸²æŸ“ä¹‹åï¼Œæˆ‘ä»¬éœ€è¦æ‰§è¡Œä¸€æ¬¡ effect
    execute()
  }

  const [count, setCount] = myUseState(0)
  const [name, setName] = myUseState('Jet')

  const memoizedValue = myUseMemo(() => {
    return count() * 2
  })

  myUseEffect(() => {
    console.log(memoizedValue())
  })

  return (
    <div>
      <p>You clicked {count()} times</p>
      <button onClick={() => setCount(count() + 1)}>
        Click me
      </button>
      <p>My name is {name()}</p>
      <button onClick={() => setName('JeLlab')}>
        Change name
      </button>
    </div>
  )
}
```

<iframe src="https://stackblitz.com/edit/react-ts-yufgad?embed=1&file=App.tsx" style={{ width: '100%', height: '500px', border: 0 }}
  className={'rounded-md'}
></iframe>
