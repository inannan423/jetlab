---
title: ä¸‰è‰²æ ‡è®°æ³•ä¸æ··åˆå†™å±éšœï¼šGo è¯­è¨€åƒåœ¾å›æ”¶çš„æ·±åº¦è§£æ
date: "2025-06-07"
description: æœ¬æ–‡å°†æ·±å…¥å‰–æ Go è¯­è¨€çš„åƒåœ¾å›æ”¶æœºåˆ¶ï¼Œå¸®åŠ©ä½ æ›´å¥½åœ°ç†è§£ Go è¯­è¨€çš„å†…å­˜ç®¡ç†ã€‚
published: true
tags: ["Go", "ç¼–ç¨‹è¯­è¨€", "æ·±å…¥å‰–æ", "åƒåœ¾å›æ”¶", "å†…å­˜ç®¡ç†"]
---

å½“æˆ‘ä»¬åœ¨è®¨è®º Go è¯­è¨€çš„ä¼˜åŠ¿æ—¶ï¼Œæ€»æ˜¯ä¼šæåˆ°å®ƒå‡ºè‰²çš„åƒåœ¾å›æ”¶èƒ½åŠ›ã€‚ä½†æ˜¯ï¼Œä»€ä¹ˆæ˜¯åƒåœ¾å›æ”¶ï¼ŸGo çš„åƒåœ¾å›æ”¶å™¨åˆæ˜¯å¦‚ä½•å·¥ä½œçš„å‘¢ï¼Ÿä¸ºä»€ä¹ˆå®ƒèƒ½åœ¨ä¿è¯ç¨‹åºæ€§èƒ½çš„åŒæ—¶ï¼Œè¿˜èƒ½è‡ªåŠ¨ç®¡ç†å†…å­˜ï¼Ÿ

ä»Šå¤©ï¼Œæˆ‘ä»¬å°±æ¥æ·±å…¥å‰–æ Go è¯­è¨€çš„åƒåœ¾å›æ”¶æœºåˆ¶ï¼Œä»æœ€åŸºç¡€çš„æ¦‚å¿µå¼€å§‹ï¼Œé€æ­¥æ·±å…¥åˆ°ä¸‰è‰²æ ‡è®°æ³•ã€å†™å±éšœç­‰é«˜çº§æ¦‚å¿µï¼Œè®©ä½ å½»åº•ç†è§£ Go æ˜¯å¦‚ä½•åœ¨å¹•åé»˜é»˜å®ˆæŠ¤ä½ çš„ç¨‹åºçš„ã€‚

## ä¸ºå•¥éœ€è¦åƒåœ¾å›æ”¶ï¼Ÿ

æƒ³è±¡ä¸€ä¸‹ä½ æ­£åœ¨ç»è¥ä¸€å®¶ç¹å¿™çš„å’–å•¡å…ã€‚æ¯å¤©æœ‰æ— æ•°çš„é¡¾å®¢è¿›è¿›å‡ºå‡ºï¼Œä½¿ç”¨ç€å’–å•¡å…é‡Œçš„æ¡Œæ¤…ã€æ¯å…·ã€‚å¦‚æœæ²¡æœ‰æ¸…æ´å·¥å®šæœŸæ”¶æ‹¾æ¡Œå­ã€å›æ”¶æ¯å…·ï¼Œå¾ˆå¿«å’–å•¡å…å°±ä¼šè¢«åƒåœ¾æ·¹æ²¡ï¼Œæ–°é¡¾å®¢æ ¹æœ¬æ‰¾ä¸åˆ°å¯ç”¨çš„åº§ä½ã€‚

ç¨‹åºçš„å†…å­˜ç®¡ç†ä¹Ÿæ˜¯å¦‚æ­¤ã€‚åœ¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¸æ–­åœ°åˆ›å»ºå¯¹è±¡ã€åˆ†é…å†…å­˜ï¼Œè¿™äº›å¯¹è±¡å°±åƒå’–å•¡å…é‡Œçš„æ¯å…·ä¸€æ ·ã€‚å½“è¿™äº›å¯¹è±¡ä¸å†è¢«ä½¿ç”¨æ—¶ï¼Œå®ƒä»¬å°±å˜æˆäº†"åƒåœ¾"ï¼Œå ç”¨ç€å®è´µçš„å†…å­˜ç©ºé—´ã€‚å¦‚æœä¸åŠæ—¶æ¸…ç†ï¼Œç¨‹åºæœ€ç»ˆä¼šå› ä¸ºå†…å­˜è€—å°½è€Œå´©æºƒã€‚

åœ¨ C è¯­è¨€ä¸­ï¼Œç¨‹åºå‘˜éœ€è¦æ‰‹åŠ¨ç®¡ç†å†…å­˜ï¼š

```c
char *buffer = malloc(1024);  // ç”³è¯·å†…å­˜
// ä½¿ç”¨ buffer...
free(buffer);                 // æ‰‹åŠ¨é‡Šæ”¾å†…å­˜
```

è¿™ç§æ‰‹åŠ¨ç®¡ç†æ–¹å¼è™½ç„¶ç»™äº†ç¨‹åºå‘˜å®Œå…¨çš„æ§åˆ¶æƒï¼Œä½†ä¹Ÿå¸¦æ¥äº†å¾ˆå¤šé—®é¢˜ï¼š

**å†…å­˜æ³„æ¼**ï¼šå¿˜è®°é‡Šæ”¾ä¸å†ä½¿ç”¨çš„å†…å­˜ï¼Œå¯¼è‡´å†…å­˜å ç”¨è¶Šæ¥è¶Šé«˜ã€‚å°±åƒå’–å•¡å…çš„æœåŠ¡å‘˜å¿˜è®°æ”¶æ‹¾æ¡Œå­ï¼Œæœ€ç»ˆæ²¡æœ‰ç©ºæ¡Œå¯ç”¨ã€‚

**æ‚¬ç©ºæŒ‡é’ˆ**ï¼šé‡Šæ”¾å†…å­˜åä»ç„¶ä½¿ç”¨æŒ‡å‘è¯¥å†…å­˜çš„æŒ‡é’ˆï¼Œå¯¼è‡´ç¨‹åºå´©æºƒã€‚è¿™å°±åƒæœåŠ¡å‘˜æŠŠè¿˜åœ¨ä½¿ç”¨çš„æ¡Œå­æ”¶èµ°äº†ï¼Œé¡¾å®¢ç¬é—´æ‡µåœˆ ğŸ˜µâ€ğŸ’«ã€‚

**é‡å¤é‡Šæ”¾**ï¼šåŒä¸€å—å†…å­˜è¢«é‡Šæ”¾å¤šæ¬¡ï¼Œå¯¼è‡´ç¨‹åºè¡Œä¸ºæœªå®šä¹‰ã€‚


![åº—å‘˜æŠŠæ¡Œå­æ”¶èµ°äº†](/blogs/go-garbage-collection/coffe-desk-move.png)

è¿™äº›é—®é¢˜åœ¨å¤§å‹é¡¹ç›®ä¸­å°¤å…¶çªå‡ºï¼Œç¨‹åºå‘˜éœ€è¦èŠ±è´¹å¤§é‡ç²¾åŠ›åœ¨å†…å­˜ç®¡ç†ä¸Šï¼Œè€Œä¸æ˜¯ä¸“æ³¨äºä¸šåŠ¡é€»è¾‘çš„å®ç°ã€‚

åƒåœ¾å›æ”¶å°±æ˜¯ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜è€Œè¯ç”Ÿçš„ã€‚å®ƒå°±åƒä¸€ä¸ªæ™ºèƒ½çš„æ¸…æ´å·¥ï¼Œèƒ½å¤Ÿè‡ªåŠ¨è¯†åˆ«å“ªäº›å†…å­˜ä¸å†è¢«ä½¿ç”¨ï¼Œå¹¶å°†å…¶å›æ”¶ï¼Œé‡Šæ”¾ç»™ç¨‹åºé‡æ–°ä½¿ç”¨ã€‚è¿™æ ·ï¼Œç¨‹åºå‘˜å°±å¯ä»¥ä¸“æ³¨äºç¼–å†™ä¸šåŠ¡é€»è¾‘ï¼Œè€Œä¸ç”¨æ‹…å¿ƒå†…å­˜ç®¡ç†çš„ç»†èŠ‚ã€‚

Go è¯­è¨€çš„åƒåœ¾å›æ”¶å™¨æ›´æ˜¯å°†è¿™ä¸ªç†å¿µå‘æŒ¥åˆ°äº†æè‡´ï¼šå®ƒä¸ä»…èƒ½è‡ªåŠ¨å›æ”¶åƒåœ¾ï¼Œè¿˜èƒ½åœ¨ä¿è¯ç¨‹åºä½å»¶è¿Ÿçš„åŒæ—¶é«˜æ•ˆåœ°å·¥ä½œã€‚è¿™å¯¹äºè¦ä½¿ç”¨ Web æœåŠ¡ã€äº‘è®¡ç®—ç­‰é«˜å¹¶å‘åœºæ™¯çš„ Go ç¨‹åºæ¥è¯´ï¼Œç®€ç›´æ˜¯ç¦éŸ³ã€‚

## å›æ”¶è°ï¼Ÿ

æ—¢ç„¶è¦åšåƒåœ¾å›æ”¶ï¼Œé¦–å…ˆå¾—ææ¸…æ¥šï¼šä»€ä¹ˆæ ·çš„å¯¹è±¡ç®—æ˜¯"åƒåœ¾"ï¼Ÿ

åœ¨ç¨‹åºçš„ä¸–ç•Œé‡Œï¼Œåˆ¤æ–­ä¸€ä¸ªå¯¹è±¡æ˜¯å¦ä¸ºåƒåœ¾çš„æ ‡å‡†å¾ˆç®€å•ï¼š**å¦‚æœè¿™ä¸ªå¯¹è±¡ä¸èƒ½å†è¢«ç¨‹åºè®¿é—®åˆ°ï¼Œé‚£å®ƒå°±æ˜¯åƒåœ¾**ã€‚æ›´ä¸“ä¸šåœ°è¯´ï¼Œå¦‚æœä»ç¨‹åºçš„æ ¹å¯¹è±¡ï¼ˆæ¯”å¦‚å…¨å±€å˜é‡ã€æ ˆä¸Šçš„å˜é‡ï¼‰å‡ºå‘ï¼Œé€šè¿‡ä»»ä½•å¼•ç”¨é“¾éƒ½æ— æ³•åˆ°è¾¾è¿™ä¸ªå¯¹è±¡ï¼Œé‚£è¿™ä¸ªå¯¹è±¡å°±å¯ä»¥è¢«å›æ”¶äº†ã€‚

è®©æˆ‘ä»¬ç”¨ä¸€ä¸ªå…·ä½“çš„ä¾‹å­æ¥ç†è§£ï¼š

```go
func createObjects() (*Person, *Person, *Person) {
    a := &Person{Name: "Alice"}    // a æŒ‡å‘ä¸€ä¸ª Person å¯¹è±¡
    b := &Person{Name: "Bob"}      // b æŒ‡å‘å¦ä¸€ä¸ª Person å¯¹è±¡
    a.Friend = b                   // Alice çš„æœ‹å‹æ˜¯ Bob
    b.Friend = a                   // Bob çš„æœ‹å‹æ˜¯ Alice
    
    c := &Person{Name: "Charlie"}  // c æŒ‡å‘ç¬¬ä¸‰ä¸ªå¯¹è±¡
    
    // å‡½æ•°ç»“æŸæ—¶ï¼Œå±€éƒ¨å˜é‡ aã€bã€c éƒ½ä¼šè¢«é”€æ¯
    // ä½†å®ƒä»¬æŒ‡å‘çš„å¯¹è±¡åœ¨å †ä¸Šï¼Œéœ€è¦åƒåœ¾å›æ”¶å™¨å¤„ç†
    return a, b, c  // ğŸ‘ˆ é€ƒé€¸ï¼å› ä¸ºè¿”å›ç»™å‡½æ•°å¤–éƒ¨
}
```

å½“ `createObjects` å‡½æ•°æ‰§è¡Œå®Œæ¯•åï¼Œå±€éƒ¨å˜é‡ aã€bã€c éƒ½è¢«é”€æ¯äº†ã€‚è¿™æ—¶å€™ï¼š

- Alice å’Œ Bob å¯¹è±¡è™½ç„¶äº’ç›¸å¼•ç”¨ï¼Œä½†ä»ç¨‹åºçš„æ ¹å¯¹è±¡å‡ºå‘å·²ç»æ— æ³•åˆ°è¾¾å®ƒä»¬ï¼Œæ‰€ä»¥å®ƒä»¬éƒ½æ˜¯åƒåœ¾ã€‚
- Charlie å¯¹è±¡åŒæ ·æ— æ³•ä»æ ¹å¯¹è±¡åˆ°è¾¾ï¼Œä¹Ÿæ˜¯åƒåœ¾ã€‚

è¿™é‡Œæœ‰ä¸ªæœ‰è¶£çš„æƒ…å†µï¼šAlice å’Œ Bob äº’ç›¸å¼•ç”¨ï¼Œå½¢æˆäº†ä¸€ä¸ªç¯å½¢å¼•ç”¨ã€‚å¦‚æœä½¿ç”¨ç®€å•çš„å¼•ç”¨è®¡æ•°æ³•ï¼ˆæ¯ä¸ªå¯¹è±¡è®°å½•æœ‰å¤šå°‘ä¸ªå¼•ç”¨æŒ‡å‘å®ƒï¼‰ï¼Œè¿™ä¸¤ä¸ªå¯¹è±¡çš„å¼•ç”¨è®¡æ•°éƒ½ä¸ä¸ºé›¶ï¼Œæ— æ³•è¢«å›æ”¶ï¼Œä»è€Œé€ æˆå†…å­˜æ³„æ¼ã€‚

![å¯¹è±¡å¼•ç”¨å…³ç³»ç¤ºæ„å›¾](/blogs/go-garbage-collection/object-references.png)

Go çš„åƒåœ¾å›æ”¶å™¨é‡‡ç”¨çš„æ˜¯**å¯è¾¾æ€§åˆ†æ**æ–¹æ³•ï¼Œå®ƒä»æ ¹å¯¹è±¡å‡ºå‘ï¼Œæ²¿ç€å¼•ç”¨é“¾è¿›è¡Œéå†ï¼Œæ‰€æœ‰èƒ½å¤Ÿéå†åˆ°çš„å¯¹è±¡éƒ½è¢«æ ‡è®°ä¸º"æ´»è·ƒ"ï¼Œå…¶ä½™çš„å¯¹è±¡åˆ™è¢«è®¤ä¸ºæ˜¯åƒåœ¾ã€‚è¿™ç§æ–¹æ³•èƒ½å¤Ÿæ­£ç¡®å¤„ç†ç¯å½¢å¼•ç”¨çš„æƒ…å†µã€‚

æ ¹å¯¹è±¡é€šå¸¸åŒ…æ‹¬ï¼š
- å…¨å±€å˜é‡
- æ ˆä¸Šçš„å±€éƒ¨å˜é‡
- å¯„å­˜å™¨ä¸­çš„å˜é‡
- é™æ€å˜é‡ç­‰

è¿™äº›æ ¹å¯¹è±¡å°±åƒæ˜¯ä¸€å¼ å·¨å¤§ç½‘ç»œçš„èµ·ç‚¹ï¼Œåƒåœ¾å›æ”¶å™¨æ²¿ç€è¿™äº›èµ·ç‚¹ç¼–ç»‡çš„"å¼•ç”¨ç½‘"æ¥ç¡®å®šå“ªäº›å¯¹è±¡è¿˜"æ´»ç€"ï¼Œå“ªäº›å·²ç»æˆä¸ºäº†æ— äººé—®æ´¥çš„"å­¤å„¿"ã€‚

## å¤æ—©æ—¶æœŸçš„åƒåœ¾å›æ”¶ï¼šæ ‡è®°-æ¸…é™¤

åœ¨åƒåœ¾å›æ”¶çš„å‘å±•å²ä¸Šï¼Œæ ‡è®°-æ¸…é™¤ï¼ˆMark-and-Sweepï¼‰ç®—æ³•å¯ä»¥è¯´æ˜¯æœ€ç»å…¸ã€æœ€ç›´è§‚çš„åƒåœ¾å›æ”¶ç®—æ³•ã€‚è™½ç„¶ç°åœ¨çš„ Go å·²ç»ä½¿ç”¨äº†æ›´åŠ å…ˆè¿›çš„ç®—æ³•ï¼Œä½†ç†è§£æ ‡è®°-æ¸…é™¤ç®—æ³•æœ‰åŠ©äºæˆ‘ä»¬æ›´å¥½åœ°ç†è§£åç»­çš„æ”¹è¿›ã€‚

æ ‡è®°-æ¸…é™¤ç®—æ³•çš„å·¥ä½œè¿‡ç¨‹éå¸¸ç®€å•ï¼Œå°±åƒå®ƒçš„åå­—ä¸€æ ·ï¼Œåˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼š

**æ ‡è®°é˜¶æ®µï¼ˆMark Phaseï¼‰**ï¼šä»æ ¹å¯¹è±¡å‡ºå‘ï¼Œæ²¿ç€å¼•ç”¨é“¾éå†æ‰€æœ‰å¯è¾¾çš„å¯¹è±¡ï¼Œå¹¶ç»™è¿™äº›å¯¹è±¡æ‰“ä¸Š"æ´»è·ƒ"çš„æ ‡è®°ã€‚è¿™ä¸ªè¿‡ç¨‹å°±åƒåœ¨ä¸€ä¸ªå·¨å¤§çš„è¿·å®«ä¸­ï¼Œä»å…¥å£å¼€å§‹ï¼Œæ²¿ç€æ‰€æœ‰å¯èƒ½çš„è·¯å¾„è¡Œèµ°ï¼Œç»™ç»è¿‡çš„æ¯ä¸ªæˆ¿é—´éƒ½è´´ä¸Šä¸€ä¸ªç»¿è‰²çš„æ ‡ç­¾ã€‚

**æ¸…é™¤é˜¶æ®µï¼ˆSweep Phaseï¼‰**ï¼šéå†æ•´ä¸ªå †å†…å­˜ï¼Œå°†æ‰€æœ‰æ²¡æœ‰æ ‡è®°çš„å¯¹è±¡å›æ”¶æ‰ï¼Œé‡Šæ”¾å®ƒä»¬å ç”¨çš„å†…å­˜ç©ºé—´ã€‚è¿™å°±åƒåœ¨è¿·å®«ä¸­çš„å¤§æ‰«é™¤ï¼ŒæŠŠæ‰€æœ‰æ²¡æœ‰ç»¿è‰²æ ‡ç­¾çš„æˆ¿é—´éƒ½æ¸…ç©ºã€‚

![æ ‡è®°-æ¸…é™¤ç®—æ³•ç¤ºæ„å›¾](/blogs/go-garbage-collection/mark-and-sweep.png)

è®©æˆ‘ä»¬ç”¨ä»£ç æ¥æ¨¡æ‹Ÿè¿™ä¸ªè¿‡ç¨‹ï¼š

```go
// ä¼ªä»£ç ï¼šæ ‡è®°é˜¶æ®µ
func mark() {
    workList := getRootObjects()  // è·å–æ‰€æœ‰æ ¹å¯¹è±¡
    
    for len(workList) > 0 {
        obj := workList.pop()
        if !obj.isMarked() {
            obj.setMark(true)         // æ ‡è®°å¯¹è±¡
            // å°†è¯¥å¯¹è±¡å¼•ç”¨çš„æ‰€æœ‰å¯¹è±¡åŠ å…¥å·¥ä½œåˆ—è¡¨
            for ref := range obj.getReferences() {
                workList.push(ref)
            }
        }
    }
}

// ä¼ªä»£ç ï¼šæ¸…é™¤é˜¶æ®µ
func sweep() {
    for obj := range getAllObjects() {
        if obj.isMarked() {
            obj.setMark(false)  // æ¸…é™¤æ ‡è®°ï¼Œä¸ºä¸‹æ¬¡ GC åšå‡†å¤‡
        } else {
            freeObject(obj)     // å›æ”¶æœªæ ‡è®°çš„å¯¹è±¡
        }
    }
}
```

æ ‡è®°-æ¸…é™¤ç®—æ³•çš„ä¼˜ç‚¹å¾ˆæ˜æ˜¾ï¼š

- **ç®—æ³•ç®€å•**ï¼šé€»è¾‘æ¸…æ™°ï¼Œå®¹æ˜“ç†è§£å’Œå®ç°
- **å¤„ç†ç¯å½¢å¼•ç”¨**ï¼šèƒ½å¤Ÿæ­£ç¡®å¤„ç†å¯¹è±¡é—´çš„ç¯å½¢å¼•ç”¨
- **ç©ºé—´æ•ˆç‡é«˜**ï¼šåªéœ€è¦ä¸€ä¸ªæ¯”ç‰¹ä½æ¥å­˜å‚¨æ ‡è®°ä¿¡æ¯

ä½†æ˜¯ï¼Œå®ƒä¹Ÿæœ‰ä¸€ä¸ªè‡´å‘½çš„ç¼ºç‚¹ï¼š**éœ€è¦ STWï¼ˆStop The Worldï¼‰**ã€‚

STW æ„å‘³ç€åœ¨åƒåœ¾å›æ”¶æœŸé—´ï¼Œç¨‹åºçš„æ‰€æœ‰çº¿ç¨‹éƒ½å¿…é¡»åœæ­¢è¿è¡Œï¼Œç­‰å¾…åƒåœ¾å›æ”¶å®Œæˆã€‚è¿™å°±åƒæ˜¯æ•´ä¸ªå’–å•¡å…åœ¨æ¸…æ´æ—¶é—´å¿…é¡»åœæ­¢è¥ä¸šï¼Œæ‰€æœ‰é¡¾å®¢éƒ½è¦ç­‰åœ¨é—¨å¤–ã€‚

Go ä½¿ç”¨ä¸€ä¸ªå« `GOGC` çš„å‚æ•°ï¼ˆé»˜è®¤å€¼ä¸º 100ï¼‰æ§åˆ¶ GC è§¦å‘é¢‘ç‡ï¼Œåœ¨ä¸€æ¬¡ GC ç»“æŸåï¼Œå¦‚æœå †çš„å¤§å°å¢é•¿äº† `GOGC%`ï¼Œå°±ä¼šè§¦å‘ä¸‹ä¸€æ¬¡ GCï¼š  

ä¸¾ä¾‹ï¼šGC åå †å¤§å°æ˜¯ 100MB â†’ å¢é•¿åˆ° 200MB ä¼šè§¦å‘ä¸‹ä¸€æ¬¡ GCï¼›å¦‚æœ GOGC=100ï¼Œæ„æ€æ˜¯â€œå †å¤§å°å¢é•¿ä¸€å€åè§¦å‘â€ï¼›åŒæ—¶ï¼Œæ¯æ¬¡å†…å­˜åˆ†é…æ—¶éƒ½ä¼šæ£€æŸ¥æ˜¯å¦è¶…è¿‡é˜ˆå€¼ï¼›æ²¡æœ‰å®šæ—¶å™¨ã€åå° GC çº¿ç¨‹ï¼Œçº¯è¢«åŠ¨è§¦å‘ï¼Œæ‰€æœ‰ goroutine æš‚åœï¼ˆSTWï¼‰ã€‚

![STW ç¤ºæ„å›¾](/blogs/go-garbage-collection/stw.png)

å¯¹äºæ—©æœŸçš„ç¨‹åºæ¥è¯´ï¼Œè¿™å¯èƒ½ä¸æ˜¯ä»€ä¹ˆå¤§é—®é¢˜ã€‚ä½†å¯¹äºç°ä»£çš„æœåŠ¡å™¨åº”ç”¨ï¼Œç‰¹åˆ«æ˜¯é‚£äº›éœ€è¦ä½å»¶è¿Ÿå“åº”çš„ç³»ç»Ÿï¼ŒSTW æ—¶é—´è¿‡é•¿æ˜¯ç»å¯¹ä¸èƒ½å®¹å¿çš„ã€‚æƒ³è±¡ä¸€ä¸‹ï¼Œå¦‚æœä¸€ä¸ªå¤„ç†ç”¨æˆ·è¯·æ±‚çš„æœåŠ¡å™¨å› ä¸ºåƒåœ¾å›æ”¶è€Œæš‚åœå‡ ç™¾æ¯«ç§’ï¼Œç”¨æˆ·ä½“éªŒå°†ä¼šå¤šä¹ˆç³Ÿç³•ã€‚

Go æ—©æœŸçš„åƒåœ¾å›æ”¶å™¨ç¡®å®ä½¿ç”¨è¿‡æ ‡è®°-æ¸…é™¤ç®—æ³•ï¼Œä½†éšç€å¯¹æ€§èƒ½è¦æ±‚çš„ä¸æ–­æé«˜ï¼ŒGo å›¢é˜Ÿå¼€å§‹å¯»æ±‚æ›´å¥½çš„è§£å†³æ–¹æ¡ˆã€‚è¿™å°±å¼•å‡ºäº†æˆ‘ä»¬æ¥ä¸‹æ¥è¦è®¨è®ºçš„ä¸‰è‰²æ ‡è®°ç®—æ³•ã€‚

## å¹¶å‘å›æ”¶ï¼Œå¼•å…¥ä¸‰è‰²æ ‡è®°å’Œæ’å…¥åˆ é™¤å±éšœ

ä¸ºäº†è§£å†³æ ‡è®°-æ¸…é™¤ç®—æ³• STW æ—¶é—´è¿‡é•¿çš„é—®é¢˜ï¼ŒGo çš„åƒåœ¾å›æ”¶å™¨è¿›åŒ–å‡ºäº†ä¸€ä¸ªæ›´åŠ ç²¾å¦™çš„ç®—æ³•ï¼š**ä¸‰è‰²æ ‡è®°æ³•**ã€‚

ä¸‰è‰²æ ‡è®°æ³•çš„æ ¸å¿ƒæ€æƒ³æ˜¯å°†å¯¹è±¡åˆ†ä¸ºä¸‰ç§é¢œè‰²ï¼š

**ç™½è‰²ï¼ˆWhiteï¼‰**ï¼šæœªè¢«è®¿é—®çš„å¯¹è±¡ï¼Œåƒåœ¾å›æ”¶ç»“æŸæ—¶ï¼Œæ‰€æœ‰ç™½è‰²å¯¹è±¡éƒ½ä¼šè¢«å›æ”¶ã€‚

**ç°è‰²ï¼ˆGrayï¼‰**ï¼šå·²è¢«è®¿é—®ä½†å…¶å¼•ç”¨çš„å¯¹è±¡è¿˜æœªå…¨éƒ¨è®¿é—®çš„å¯¹è±¡ï¼Œè¿™äº›å¯¹è±¡å¤„äº"å¾…å¤„ç†"çŠ¶æ€ã€‚

**é»‘è‰²ï¼ˆBlackï¼‰**ï¼šå·²è¢«è®¿é—®ä¸”å…¶å¼•ç”¨çš„æ‰€æœ‰å¯¹è±¡éƒ½å·²è¢«è®¿é—®çš„å¯¹è±¡ï¼Œè¿™äº›å¯¹è±¡ç¡®å®šæ˜¯æ´»è·ƒçš„ã€‚

è¿™ä¸ªè¿‡ç¨‹å°±åƒæ˜¯åœ¨ä¸€ä¸ªå·¨å¤§çš„å›¾ä¹¦é¦†ä¸­è¿›è¡Œå›¾ä¹¦æ•´ç†ï¼š

- åˆšå¼€å§‹æ—¶ï¼Œæ‰€æœ‰çš„ä¹¦éƒ½æ˜¯ç™½è‰²çš„ï¼ˆæœªå¤„ç†ï¼‰
- ç®¡ç†å‘˜ä»å…¥å£å¼€å§‹ï¼Œå°†çœ‹åˆ°çš„ä¹¦æ ‡è®°ä¸ºç°è‰²ï¼ˆå‘ç°ä½†æœªå®Œå…¨å¤„ç†ï¼‰
- å¯¹äºæ¯æœ¬ç°è‰²çš„ä¹¦ï¼Œç®¡ç†å‘˜ä¼šæ£€æŸ¥å®ƒå¼•ç”¨çš„æ‰€æœ‰å…¶ä»–ä¹¦ç±ï¼Œå¹¶å°†è¿™äº›ä¹¦ä¹Ÿæ ‡è®°ä¸ºç°è‰²
- å½“ä¸€æœ¬ä¹¦çš„æ‰€æœ‰å¼•ç”¨éƒ½è¢«æ£€æŸ¥å®Œæ¯•åï¼Œè¿™æœ¬ä¹¦å°±å˜æˆé»‘è‰²ï¼ˆå®Œå…¨å¤„ç†ï¼‰
- æœ€ç»ˆï¼Œæ‰€æœ‰ç™½è‰²çš„ä¹¦ç±éƒ½è¢«è®¤ä¸ºæ˜¯æ— ç”¨çš„ï¼Œå¯ä»¥è¢«æ¸…ç†æ‰

![ä¸‰è‰²æ ‡è®°æ³•ç¤ºæ„å›¾](/blogs/go-garbage-collection/tri-color-marking.png)

ä¸‰è‰²æ ‡è®°æ³•çš„å·¥ä½œæµç¨‹å¦‚ä¸‹ï¼š

1. **åˆå§‹åŒ–**ï¼šæ‰€æœ‰å¯¹è±¡éƒ½æ ‡è®°ä¸ºç™½è‰²ï¼Œå°†æ ¹å¯¹è±¡æ ‡è®°ä¸ºç°è‰²
2. **æ ‡è®°è¿‡ç¨‹**ï¼š
   - ä»ç°è‰²å¯¹è±¡é›†åˆä¸­å–å‡ºä¸€ä¸ªå¯¹è±¡
   - å°†è¯¥å¯¹è±¡æ ‡è®°ä¸ºé»‘è‰²
   - å°†è¯¥å¯¹è±¡ç›´æ¥å¼•ç”¨çš„æ‰€æœ‰ç™½è‰²å¯¹è±¡æ ‡è®°ä¸ºç°è‰²
   - é‡å¤ä¸Šè¿°è¿‡ç¨‹ï¼Œç›´åˆ°æ²¡æœ‰ç°è‰²å¯¹è±¡
3. **æ¸…é™¤è¿‡ç¨‹**ï¼šå›æ”¶æ‰€æœ‰ç™½è‰²å¯¹è±¡

```go
// ä¼ªä»£ç ï¼šä¸‰è‰²æ ‡è®°ç®—æ³•
func triColorMark() {
    // åˆå§‹åŒ–ï¼šæ‰€æœ‰å¯¹è±¡éƒ½æ˜¯ç™½è‰²
    grayObjects := make([]Object, 0)
    
    // å°†æ ¹å¯¹è±¡æ ‡è®°ä¸ºç°è‰²
    for root := range getRootObjects() {
        root.setColor(GRAY)
        grayObjects = append(grayObjects, root)
    }
    
    // å¤„ç†æ‰€æœ‰ç°è‰²å¯¹è±¡
    for len(grayObjects) > 0 {
        obj := grayObjects[0]
        grayObjects = grayObjects[1:]
        
        // å°†å½“å‰å¯¹è±¡æ ‡è®°ä¸ºé»‘è‰²
        obj.setColor(BLACK)
        
        // å°†å…¶å¼•ç”¨çš„ç™½è‰²å¯¹è±¡æ ‡è®°ä¸ºç°è‰²
        for ref := range obj.getReferences() {
            if ref.getColor() == WHITE {
                ref.setColor(GRAY)
                grayObjects = append(grayObjects, ref)
            }
        }
    }
    
    // æ¸…é™¤æ‰€æœ‰ç™½è‰²å¯¹è±¡
    for obj := range getAllObjects() {
        if obj.getColor() == WHITE {
            freeObject(obj)
        }
    }
}
```

### ä¸‰è‰²æ ‡è®°æ³•ä¸‹è¿˜éœ€è¦ STW å—ï¼Ÿ

ç†è®ºä¸Šæ¥è¯´ï¼Œä¸‰è‰²æ ‡è®°æ³•ç¡®å®ä¸ºå¹¶å‘åƒåœ¾å›æ”¶æä¾›äº†å¯èƒ½ã€‚æ—¢ç„¶æˆ‘ä»¬å¯ä»¥ç”¨ä¸‰ç§é¢œè‰²æ¥è¡¨ç¤ºå¯¹è±¡çš„çŠ¶æ€ï¼Œé‚£ä¹ˆæ˜¯å¦å¯ä»¥è®©åƒåœ¾å›æ”¶å™¨å’Œç”¨æˆ·ç¨‹åºåŒæ—¶è¿è¡Œå‘¢ï¼Ÿ

ç­”æ¡ˆæ˜¯ï¼šå¯ä»¥ï¼Œä½†æœ‰æ¡ä»¶ã€‚

å¦‚æœåœ¨åƒåœ¾å›æ”¶è¿‡ç¨‹ä¸­ï¼Œç”¨æˆ·ç¨‹åºä¸ä¿®æ”¹ä»»ä½•å¯¹è±¡ä¹‹é—´çš„å¼•ç”¨å…³ç³»ï¼Œé‚£ä¹ˆä¸‰è‰²æ ‡è®°æ³•å¯ä»¥å®Œç¾åœ°å¹¶å‘å·¥ä½œã€‚ä½†ç°å®ä¸­ï¼Œç”¨æˆ·ç¨‹åºæ€»æ˜¯åœ¨ä¸æ–­åœ°åˆ›å»ºæ–°å¯¹è±¡ã€ä¿®æ”¹å¼•ç”¨å…³ç³»ï¼Œè¿™å°±å¯èƒ½å¯¼è‡´ä¸€äº›ä¸¥é‡çš„é—®é¢˜ã€‚

### å¦‚æœä¸ç”¨ STW å‘¢ï¼Ÿ

è®©æˆ‘ä»¬çœ‹çœ‹å¦‚æœä¸ä½¿ç”¨ STWï¼Œåœ¨å¹¶å‘æ ‡è®°è¿‡ç¨‹ä¸­å¯èƒ½å‡ºç°ä»€ä¹ˆé—®é¢˜ã€‚

**é—®é¢˜ä¸€ï¼šå¯¹è±¡ä¸¢å¤±**

è€ƒè™‘è¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼Œåœ¨æŸæ¬¡æˆ‘ä»¬æ‰§è¡Œåƒåœ¾å›æ”¶æ—¶ï¼Œåˆ«çš„ goroutine æ­£åœ¨å¹¶å‘åœ°ä¿®æ”¹å¯¹è±¡å¼•ç”¨å…³ç³»ï¼š
1. å¯¹è±¡ Aï¼ˆé»‘è‰²ï¼‰å¼•ç”¨å¯¹è±¡ Bï¼ˆç°è‰²ï¼‰
2. å¯¹è±¡ B å¼•ç”¨å¯¹è±¡ Cï¼ˆç™½è‰²ï¼‰
3. ç”¨æˆ·ç¨‹åºè®©å¯¹è±¡ A ç›´æ¥å¼•ç”¨å¯¹è±¡ Cï¼š`A.ref = C`
4. åŒæ—¶ï¼Œç”¨æˆ·ç¨‹åºåˆ é™¤äº† B å¯¹ C çš„å¼•ç”¨ï¼š`B.ref = nil`

æ­¤æ—¶å°±å‡ºç°äº†é—®é¢˜ï¼š
- å¯¹è±¡ A å·²ç»æ˜¯é»‘è‰²ï¼Œåƒåœ¾å›æ”¶å™¨ä¸ä¼šå†æ£€æŸ¥å®ƒçš„å¼•ç”¨
- å¯¹è±¡ B ä¼šè¢«æ ‡è®°ä¸ºé»‘è‰²ï¼Œä½†å®ƒå·²ç»ä¸å†å¼•ç”¨ C äº†
- å¯¹è±¡ C ä»ç„¶æ˜¯ç™½è‰²ï¼Œæœ€ç»ˆä¼šè¢«é”™è¯¯å›æ”¶
- ä½†å®é™…ä¸Š A è¿˜åœ¨å¼•ç”¨ Cï¼ŒC ä¸åº”è¯¥è¢«å›æ”¶ï¼

![å¯¹è±¡ä¸¢å¤±é—®é¢˜ç¤ºæ„å›¾](/blogs/go-garbage-collection/object-loss-problem.png)

**é—®é¢˜äºŒï¼šæ‚¬ç©ºæŒ‡é’ˆ**

å¦ä¸€ä¸ªé—®é¢˜æ˜¯å¯èƒ½äº§ç”Ÿæ‚¬ç©ºæŒ‡é’ˆï¼š
1. åƒåœ¾å›æ”¶å™¨æ­£åœ¨å¤„ç†æŸä¸ªå¯¹è±¡
2. ç”¨æˆ·ç¨‹åºæ­¤æ—¶åˆ é™¤äº†å¯¹è¯¥å¯¹è±¡çš„æœ€åä¸€ä¸ªå¼•ç”¨
3. åƒåœ¾å›æ”¶å™¨å¯èƒ½é”™è¯¯åœ°è®¤ä¸ºè¯¥å¯¹è±¡ä»ç„¶æ˜¯æ´»è·ƒçš„

è¿™äº›é—®é¢˜è¡¨æ˜ï¼Œç®€å•åœ°è®©åƒåœ¾å›æ”¶å™¨å’Œç”¨æˆ·ç¨‹åºå¹¶å‘è¿è¡Œæ˜¯ä¸å®‰å…¨çš„ã€‚æˆ‘ä»¬éœ€è¦ä¸€äº›æœºåˆ¶æ¥ç¡®ä¿å¹¶å‘çš„æ­£ç¡®æ€§ã€‚

### "å¼º"-"å¼±" ä¸‰è‰²ä¸å˜å¼å°è¯•è§£å†³ä¸ç”¨ STW çš„é—®é¢˜

ä¸ºäº†è§£å†³å¹¶å‘æ ‡è®°ä¸­çš„å¯¹è±¡ä¸¢å¤±é—®é¢˜ï¼Œç ”ç©¶äººå‘˜æå‡ºäº†ä¸¤ä¸ªé‡è¦çš„ä¸å˜å¼ï¼ˆInvariantï¼‰æ¥çº¦æŸå¯¹è±¡å¼•ç”¨çš„ä¿®æ”¹ã€‚è¿™ä¸¤ä¸ªä¸å˜å¼å°±åƒæ˜¯äº¤é€šè§„åˆ™ï¼Œç¡®ä¿åœ¨å¹¶å‘ç¯å¢ƒä¸‹ä¸ä¼šå‘ç”Ÿ"äº¤é€šäº‹æ•…"ã€‚

**å¼ºä¸‰è‰²ä¸å˜å¼ï¼ˆStrong Tri-Color Invariantï¼‰**ï¼š
é»‘è‰²å¯¹è±¡ä¸èƒ½ç›´æ¥æŒ‡å‘ç™½è‰²å¯¹è±¡ã€‚

å¦‚æœä¸¥æ ¼éµå®ˆè¿™ä¸ªè§„åˆ™ï¼Œå°±ä¸ä¼šå‡ºç°å¯¹è±¡ä¸¢å¤±çš„é—®é¢˜ï¼Œå› ä¸ºé»‘è‰²å¯¹è±¡ï¼ˆå·²å®Œæˆæ ‡è®°çš„å¯¹è±¡ï¼‰æ°¸è¿œä¸ä¼šæŒ‡å‘ç™½è‰²å¯¹è±¡ï¼ˆæœªæ ‡è®°çš„å¯¹è±¡ï¼‰ã€‚

![å¼ºä¸‰è‰²ä¸å˜å¼ç¤ºæ„å›¾](/blogs/go-garbage-collection/invariants.png)

**å¼±ä¸‰è‰²ä¸å˜å¼ï¼ˆWeak Tri-Color Invariantï¼‰**ï¼š
é»‘è‰²å¯¹è±¡å¯ä»¥æŒ‡å‘ç™½è‰²å¯¹è±¡ï¼Œä½†æŒ‡å‘ç™½è‰²å¯¹è±¡çš„é»‘è‰²å¯¹è±¡å¿…é¡»å­˜åœ¨ä¸€æ¡ä»ç°è‰²å¯¹è±¡å‡ºå‘çš„è·¯å¾„ã€‚

å¼±ä¸‰è‰²ä¸å˜å¼ç›¸å¯¹å®½æ¾ä¸€äº›ï¼Œå…è®¸é»‘è‰²å¯¹è±¡æŒ‡å‘ç™½è‰²å¯¹è±¡ï¼Œä½†è¦æ±‚è¿™ä¸ªç™½è‰²å¯¹è±¡å¿…é¡»"æœ‰æ•‘"â€”â€”å³å­˜åœ¨ä¸€æ¡ä»ç°è‰²å¯¹è±¡ï¼ˆè¿˜æœªå®Œæˆæ ‡è®°çš„å¯¹è±¡ï¼‰åˆ°è¯¥ç™½è‰²å¯¹è±¡çš„è·¯å¾„ï¼Œç¡®ä¿è¿™ä¸ªç™½è‰²å¯¹è±¡æœ€ç»ˆä¼šè¢«æ ‡è®°åˆ°ã€‚

![å¼±ä¸‰è‰²ä¸å˜å¼ç¤ºæ„å›¾](/blogs/go-garbage-collection/weak-invariant.png)

ä¸¾ä¸ªä¾‹å­æ¥ç†è§£å¼±ä¸‰è‰²ä¸å˜å¼ï¼š
- å¯¹è±¡ Aï¼ˆé»‘è‰²ï¼‰å¯ä»¥æŒ‡å‘å¯¹è±¡ Cï¼ˆç™½è‰²ï¼‰
- ä½†å¿…é¡»å­˜åœ¨ä¸€æ¡è·¯å¾„ï¼šç°è‰²å¯¹è±¡ B â†’ ... â†’ ç™½è‰²å¯¹è±¡ C
- è¿™æ ·å½“å¤„ç†å¯¹è±¡ B æ—¶ï¼Œæœ€ç»ˆè¿˜æ˜¯ä¼šæ‰¾åˆ°å¯¹è±¡ C

è¿™ä¸¤ä¸ªä¸å˜å¼ä¸ºæˆ‘ä»¬æä¾›äº†ç†è®ºåŸºç¡€ï¼Œä½†å…³é”®é—®é¢˜æ˜¯ï¼šå¦‚ä½•åœ¨å®é™…è¿è¡Œä¸­ç»´æŠ¤è¿™äº›ä¸å˜å¼ï¼Ÿ

### æ’å…¥å±éšœæˆ–è€…åˆ é™¤å±éšœæ€ä¹ˆè·µè¡Œä¸‰è‰²ä¸å˜å¼

ä¸ºäº†åœ¨è¿è¡Œæ—¶ç»´æŠ¤ä¸‰è‰²ä¸å˜å¼ï¼Œæœ‰äººæå‡ºäº†**å†™å±éšœ**ï¼ˆWrite Barrierï¼‰æŠ€æœ¯ã€‚å†™å±éšœæ˜¯ä¸€ç§åœ¨ä¿®æ”¹æŒ‡é’ˆæ—¶è§¦å‘çš„æœºåˆ¶ï¼Œå¯ä»¥ç¡®ä¿å¼•ç”¨å…³ç³»çš„æ”¹å˜ä¸ä¼šè¿åä¸‰è‰²ä¸å˜å¼ã€‚

æ³¨æ„ï¼Œä¸‹é¢çš„ä¸¤ç§å±éšœæ¨¡å¼å¹¶æ²¡æœ‰åœ¨ Go çš„å†å²ç‰ˆæœ¬ä¸­å•ç‹¬å‡ºç°ï¼Œæ’å…¥å±éšœï¼Œå³ Dijkstra å±éšœï¼Œå’Œåˆ é™¤å±éšœï¼Œå³ Yuasa å±éšœï¼Œå®ƒä»¬éƒ½æ˜¯ç ”ç©¶åƒåœ¾å›æ”¶çš„ä¸“å®¶æå‡ºçš„ï¼Œä¸æ˜¯åªæœ‰ Go æ‰ä½¿ç”¨ä¸‰è‰²æ ‡è®°æ³•ã€‚

#### æ’å…¥å±éšœ

**æ’å…¥å±éšœï¼ˆInsertion Barrierï¼‰**ï¼š
åœ¨å»ºç«‹æ–°çš„å¼•ç”¨å…³ç³»æ—¶è§¦å‘ï¼Œç¡®ä¿å¼ºä¸‰è‰²ä¸å˜å¼ã€‚

```go
// ä¼ªä»£ç ï¼šæ’å…¥å±éšœ
func insertionBarrier(slot *unsafe.Pointer, ptr unsafe.Pointer) {
    if getColor(current_goroutine_stack) == BLACK && getColor(ptr) == WHITE {
        setColor(ptr, GRAY)  // å°†ç™½è‰²å¯¹è±¡å˜ä¸ºç°è‰²
    }
    *slot = ptr  // æ‰§è¡Œå®é™…çš„èµ‹å€¼æ“ä½œ
}
```

å½“ä¸€ä¸ªé»‘è‰²å¯¹è±¡è¦æŒ‡å‘ç™½è‰²å¯¹è±¡æ—¶ï¼Œæ’å…¥å±éšœä¼šç«‹å³å°†ç™½è‰²å¯¹è±¡æ ‡è®°ä¸ºç°è‰²ï¼Œç¡®ä¿å®ƒä¸ä¼šè¢«é”™è¯¯å›æ”¶ã€‚

![æ’å…¥å±éšœå·¥ä½œåŸç†ç¤ºæ„å›¾](/blogs/go-garbage-collection/insertion-barrier.png)

#### åˆ é™¤å±éšœ

**åˆ é™¤å±éšœï¼ˆDeletion Barrierï¼‰**ï¼š
åœ¨åˆ é™¤å¼•ç”¨å…³ç³»æ—¶è§¦å‘ï¼Œç¡®ä¿å¼±ä¸‰è‰²ä¸å˜å¼ã€‚

```go
// ä¼ªä»£ç ï¼šåˆ é™¤å±éšœ
func deletionBarrier(slot *unsafe.Pointer, ptr unsafe.Pointer) {
    if getColor(ptr) == WHITE {
        setColor(ptr, GRAY)  // å°†è¦è¢«åˆ é™¤å¼•ç”¨çš„ç™½è‰²å¯¹è±¡æ ‡è®°ä¸ºç°è‰²
    }
    *slot = nil  // æ‰§è¡Œå®é™…çš„åˆ é™¤æ“ä½œ
}
```

åˆ é™¤å±éšœåœ¨åˆ é™¤å¯¹ç™½è‰²å¯¹è±¡çš„å¼•ç”¨æ—¶ï¼Œä¼šå…ˆå°†è¯¥ç™½è‰²å¯¹è±¡æ ‡è®°ä¸ºç°è‰²ï¼Œç¡®ä¿å³ä½¿å¼•ç”¨è¢«åˆ é™¤ï¼Œå¯¹è±¡ä¹Ÿä¸ä¼šç«‹å³å˜æˆåƒåœ¾ã€‚

è¿™ä¹ˆåšæ˜¯ä¸ºäº†é¿å…å‡ºç°ä¸‹é¢çš„æƒ…å†µï¼š

è€ƒè™‘ä¸€ä¸ªå…¸å‹çš„é—®é¢˜åœºæ™¯ï¼šåœ¨å¹¶å‘æ ‡è®°è¿‡ç¨‹ä¸­ï¼Œç”¨æˆ·ç¨‹åºå¯èƒ½ä¼šåˆ é™¤å¯¹æŸä¸ªç™½è‰²å¯¹è±¡çš„å¼•ç”¨ï¼Œè€Œæ­¤æ—¶åƒåœ¾å›æ”¶å™¨è¿˜æ²¡æœ‰æœºä¼šå¤„ç†è¿™ä¸ªå¯¹è±¡ã€‚å¦‚æœæ²¡æœ‰åˆ é™¤å±éšœçš„ä¿æŠ¤ï¼Œå°±ä¼šå‡ºç°ä»¥ä¸‹å±é™©æƒ…å†µï¼š

**åœºæ™¯æè¿°**ï¼š
1. å¯¹è±¡ Aï¼ˆç°è‰²ï¼‰å¼•ç”¨å¯¹è±¡ Cï¼ˆç™½è‰²ï¼‰
2. å¯¹è±¡ Bï¼ˆé»‘è‰²ï¼‰ç°åœ¨è¦å¼•ç”¨å¯¹è±¡ C
3. ç”¨æˆ·ç¨‹åºæ‰§è¡Œï¼š`B.ref = C`ï¼ˆå»ºç«‹æ–°å¼•ç”¨ï¼‰
4. æ¥ç€æ‰§è¡Œï¼š`A.ref = nil`ï¼ˆåˆ é™¤åŸæœ‰å¼•ç”¨ï¼‰

**æ²¡æœ‰åˆ é™¤å±éšœæ—¶çš„é—®é¢˜**ï¼š
- å½“æ‰§è¡Œ `A.ref = nil` æ—¶ï¼Œå¦‚æœæ²¡æœ‰åˆ é™¤å±éšœï¼Œå¯¹è±¡ C çš„å¼•ç”¨å°±è¢«ç›´æ¥åˆ é™¤äº†
- æ­¤æ—¶å¯¹è±¡ C å¯èƒ½ä»ç„¶æ˜¯ç™½è‰²çš„ï¼ˆè¿˜æœªè¢«æ ‡è®°è¿‡ç¨‹å¤„ç†åˆ°ï¼‰
- è™½ç„¶å¯¹è±¡ B ç°åœ¨å¼•ç”¨ç€å¯¹è±¡ Cï¼Œä½†å¦‚æœå¯¹è±¡ B å·²ç»æ˜¯é»‘è‰²çš„ï¼Œåƒåœ¾å›æ”¶å™¨ä¸ä¼šå†æ£€æŸ¥å®ƒçš„æ–°å¼•ç”¨
- ç»“æœï¼šå¯¹è±¡ C å¯èƒ½ä¼šè¢«é”™è¯¯åœ°å›æ”¶ï¼Œå³ä½¿å®ƒä»ç„¶è¢«å¯¹è±¡ B å¼•ç”¨ç€

å¦‚å›¾ï¼š![æ²¡æœ‰åˆ é™¤å±éšœçš„æƒ…å†µç¤ºæ„å›¾](/blogs/go-garbage-collection/no-deletion-barrier.png)

**åˆ é™¤å±éšœçš„ä¿æŠ¤ä½œç”¨**ï¼š
- å½“æ‰§è¡Œ `A.ref = nil` æ—¶ï¼Œåˆ é™¤å±éšœä¼šæ£€æµ‹åˆ°è¦åˆ é™¤å¯¹ç™½è‰²å¯¹è±¡ C çš„å¼•ç”¨
- å®ƒä¼šç«‹å³å°†å¯¹è±¡ C ä»ç™½è‰²æ ‡è®°ä¸ºç°è‰²
- è¿™æ ·å³ä½¿å¼•ç”¨è¢«åˆ é™¤ï¼Œå¯¹è±¡ C ä¹Ÿä¼šåœ¨åç»­çš„æ ‡è®°è¿‡ç¨‹ä¸­è¢«æ­£ç¡®å¤„ç†
- ç¡®ä¿ä¸ä¼šå‡ºç°å¯¹è±¡ä¸¢å¤±çš„æƒ…å†µ

åˆ é™¤å±éšœçš„è¿™ç§"å®å¯é”™æ€ï¼Œä¸å¯æ”¾è¿‡"çš„ä¿å®ˆç­–ç•¥ï¼Œè™½ç„¶å¯èƒ½ä¼šè®©ä¸€äº›å®é™…ä¸Šå·²ç»å˜æˆåƒåœ¾çš„å¯¹è±¡å¤šå­˜æ´»ä¸€è½® GCï¼Œä½†å®ƒæœ‰æ•ˆåœ°é˜²æ­¢äº†æ´»è·ƒå¯¹è±¡è¢«é”™è¯¯å›æ”¶çš„ä¸¥é‡é—®é¢˜ã€‚

![åˆ é™¤å±éšœå·¥ä½œåŸç†ç¤ºæ„å›¾](/blogs/go-garbage-collection/deletion-barrier.png)

### æœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ

è™½ç„¶æ’å…¥å±éšœå’Œåˆ é™¤å±éšœéƒ½èƒ½è§£å†³å¹¶å‘æ ‡è®°çš„æ­£ç¡®æ€§é—®é¢˜ï¼Œä½†å®ƒä»¬å„è‡ªéƒ½æœ‰æ˜æ˜¾çš„ç¼ºé™·ï¼š

**æ’å…¥å±éšœçš„é—®é¢˜**ï¼š
- éœ€è¦åœ¨æ ˆä¸Šä¹Ÿå¯ç”¨å†™å±éšœï¼Œä½†æ ˆä¸Šçš„å†™æ“ä½œéå¸¸é¢‘ç¹ï¼Œè¿™ä¼šæ˜¾è‘—å½±å“æ€§èƒ½
- ä¸ºäº†é¿å…æ€§èƒ½é—®é¢˜ï¼ŒGo é€‰æ‹©ä¸åœ¨æ ˆä¸Šå¯ç”¨æ’å…¥å±éšœï¼Œä½†è¿™æ„å‘³ç€åœ¨æ ‡è®°ç»“æŸæ—¶ä»éœ€è¦ STW æ¥é‡æ–°æ‰«ææ‰€æœ‰æ ˆ

**åˆ é™¤å±éšœçš„é—®é¢˜**ï¼š
- è¿‡äºä¿å®ˆï¼Œä¼šå°†å¾ˆå¤šå®é™…ä¸Šå·²ç»æ˜¯åƒåœ¾çš„å¯¹è±¡æ ‡è®°ä¸ºæ´»è·ƒ
- è¿™å¯¼è‡´ä¸€äº›åƒåœ¾å¯¹è±¡éœ€è¦ç­‰åˆ°ä¸‹ä¸€è½® GC æ‰èƒ½è¢«å›æ”¶ï¼Œé™ä½äº†å›æ”¶æ•ˆç‡
- åŒæ ·éœ€è¦åœ¨æ ‡è®°ç»“æŸæ—¶ STW é‡æ–°å¯¹æ ˆè¿›è¡Œæ‰«æï¼Œä»¥ç¡®ä¿æ‰€æœ‰å¯¹è±¡éƒ½è¢«æ­£ç¡®æ ‡è®°

è¿™ä¸¤ç§å±éšœéƒ½æ— æ³•å®Œå…¨æ¶ˆé™¤ STWï¼Œåªæ˜¯ç¼©çŸ­äº† STW çš„æ—¶é—´ã€‚ä¸è¿‡ï¼ŒGo å›¢é˜Ÿç»“åˆäº†è¿™ä¸¤ç§å±éšœçš„ä¼˜ç‚¹ï¼Œæå‡ºäº†ä¸€ç§æ–°çš„å±éšœæœºåˆ¶ï¼š**æ··åˆå†™å±éšœ**ã€‚è¿™ç§æœºåˆ¶åœ¨ Go 1.8 ä¸­è¢«å¼•å…¥ï¼Œæ—¨åœ¨è§£å†³å‰ä¸¤ç§å±éšœçš„ç¼ºé™·ï¼ŒåŒæ—¶ä¿æŒé«˜æ•ˆçš„å¹¶å‘æ ‡è®°èƒ½åŠ›ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å°†æ·±å…¥æ¢è®¨æ··åˆå†™å±éšœçš„å·¥ä½œåŸç†å’Œè®¾è®¡æ€æƒ³ã€‚

## æ··åˆå†™å±éšœ

Go 1.5 å¼€å§‹å¼•å…¥äº†æ··åˆå†™å±éšœï¼ˆHybrid Write Barrierï¼‰ï¼Œè¿™æ˜¯åƒåœ¾å›æ”¶å™¨å‘å±•å²ä¸Šçš„ä¸€ä¸ªé‡è¦é‡Œç¨‹ç¢‘ã€‚æ··åˆå†™å±éšœå·§å¦™åœ°ç»“åˆäº†æ’å…¥å±éšœå’Œåˆ é™¤å±éšœçš„ä¼˜ç‚¹ï¼ŒåŒæ—¶é¿å…äº†å®ƒä»¬çš„ç¼ºç‚¹ï¼Œå‡ ä¹å®Œå…¨æ¶ˆé™¤äº†æ ˆé‡æ‰«æçš„éœ€è¦ã€‚ï¼ˆåœ¨ Go 1.5 ä¹‹å‰ï¼Œæ˜¯æ²¡æœ‰å±éšœæœºåˆ¶çš„ï¼Œåœ¨å¹¶å‘ç€è‰²å’Œå¹¶å‘æ ‡è®°é˜¶æ®µï¼Œéƒ½éœ€è¦ä½¿ç”¨ STW æ‰«æï¼‰

æ··åˆå†™å±éšœçš„è®¾è®¡æ€æƒ³éå¸¸å·§å¦™ï¼Œå®ƒçš„æ ¸å¿ƒåŸç†å¯ä»¥ç”¨ä¸€å¥è¯æ¦‚æ‹¬ï¼š**åœ¨ GC å¼€å§‹æ—¶ï¼Œå°†æ‰€æœ‰æ ˆä¸Šçš„å¯¹è±¡æ ‡è®°ä¸ºé»‘è‰²ï¼Œç„¶åä½¿ç”¨æ··åˆå±éšœæ¥å¤„ç†å †ä¸Šçš„å¼•ç”¨å˜åŒ–**ã€‚

ä¸ºäº†ç†è§£æ··åˆå†™å±éšœçš„ç²¾å¦™ä¹‹å¤„ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå®ƒæƒ³è±¡æˆä¸€ä¸ªé«˜æ˜çš„å®‰å…¨ç³»ç»Ÿã€‚åœ¨ä¼ ç»Ÿçš„æ’å…¥å±éšœå’Œåˆ é™¤å±éšœä¸­ï¼Œæˆ‘ä»¬å°±åƒæ˜¯é›‡ä½£äº†ä¸¤ä¸ªä¸åŒçš„ä¿å®‰ï¼šä¸€ä¸ªä¸“é—¨ç›¯ç€æ–°æ¥çš„äººï¼ˆæ’å…¥å±éšœï¼‰ï¼Œä¸€ä¸ªä¸“é—¨ç›¯ç€è¦ç¦»å¼€çš„äººï¼ˆåˆ é™¤å±éšœï¼‰ã€‚ä½†è¿™ä¸¤ä¸ªä¿å®‰éƒ½æœ‰å„è‡ªçš„ç›²ç‚¹ï¼Œéœ€è¦é¢å¤–çš„å·¡é€»æ¥ç¡®ä¿æ²¡æœ‰é—æ¼ã€‚

æ··åˆå†™å±éšœåˆ™åƒæ˜¯è®¾è®¡äº†ä¸€å¥—æ›´æ™ºèƒ½çš„å®‰å…¨ç³»ç»Ÿï¼š**åœ¨æ£€æŸ¥å¼€å§‹æ—¶ï¼Œæ‰€æœ‰å·²ç»åœ¨åœºçš„äººï¼ˆæ ˆä¸Šå¯¹è±¡ï¼‰éƒ½è¢«è®¤ä¸ºæ˜¯å¯ä¿¡çš„ï¼Œç›´æ¥ç»™ä»–ä»¬å‘æ”¾é»‘è‰²é€šè¡Œè¯ï¼›ç„¶åç”¨ä¸€å¥—ç»„åˆè§„åˆ™æ¥å¤„ç†åç»­çš„äººå‘˜æµåŠ¨**ã€‚

### æ··åˆå†™å±éšœçš„å·¥ä½œåŸç†

æ··åˆå†™å±éšœçš„å·¥ä½œå¯ä»¥åˆ†ä¸ºä¸¤ä¸ªå…³é”®æ­¥éª¤ï¼š

**ç¬¬ä¸€æ­¥ï¼šæ ˆå¿«ç…§ï¼ˆStack Snapshotï¼‰**

åœ¨ GC æ ‡è®°é˜¶æ®µå¼€å§‹æ—¶ï¼ŒGo ä¼šä¸ºæ¯ä¸ª goroutine çš„æ ˆåšä¸€ä¸ª"å¿«ç…§"ï¼Œå°†æ ˆä¸Šèƒ½å¤Ÿåˆ°è¾¾çš„æ‰€æœ‰å¯¹è±¡éƒ½æ ‡è®°ä¸ºé»‘è‰²ã€‚è¿™ä¸ªæ“ä½œéœ€è¦çŸ­æš‚çš„ STWï¼Œä½†æ—¶é—´å¾ˆçŸ­ï¼Œå› ä¸ºåªæ˜¯ç®€å•åœ°éå†æ ˆå¹¶æ ‡è®°å¯¹è±¡ï¼Œä¸éœ€è¦é€’å½’å¤„ç†ã€‚

```go
// ä¼ªä»£ç ï¼šæ ˆå¿«ç…§è¿‡ç¨‹
func takeStackSnapshot() {
    // çŸ­æš‚ STW
    stopTheWorld()
    
    for goroutine := range allGoroutines {
        for stackFrame := range goroutine.stack {
            for ref := range stackFrame.getReferences() {
                if ref != nil {
                    setColor(ref, BLACK)  // ç›´æ¥æ ‡è®°ä¸ºé»‘è‰²
                }
            }
        }
    }
    
    startTheWorld()  // æ¢å¤ç¨‹åºæ‰§è¡Œ
}
```

è¿™ä¸€æ­¥çš„å…³é”®åœ¨äºï¼Œæˆ‘ä»¬ä¸éœ€è¦é€’å½’åœ°æ ‡è®°æ ˆä¸Šå¯¹è±¡å¼•ç”¨çš„å…¶ä»–å¯¹è±¡ã€‚æˆ‘ä»¬åªæ˜¯ç»™æ ˆä¸Šç›´æ¥å¯è§çš„å¯¹è±¡ä¸€ä¸ª"å…æ­»é‡‘ç‰Œ"ï¼Œç¡®ä¿å®ƒä»¬ä¸ä¼šè¢«é”™è¯¯å›æ”¶ã€‚

> è¦æ³¨æ„ï¼Œè¿™é‡Œçš„ â€œæ ˆå¯¹è±¡â€ ä¸æ˜¯è¯´æ˜¯åœ¨æ ˆä¸Šåˆ†é…çš„å¯¹è±¡ï¼Œæ ˆä¸Šçš„å¯¹è±¡æ˜¯ä¸ä¼šè¢« GC çš„ï¼Œå› ä¸ºæ ˆä¸Šçš„å¯¹è±¡åœ¨å‡½æ•°è°ƒç”¨ç»“æŸæ—¶ä¼šè‡ªåŠ¨é‡Šæ”¾ã€‚è€Œè¿™é‡Œçš„ â€œæ ˆå¯¹è±¡â€ æŒ‡çš„æ˜¯ä¸€ä¸ªæ ˆä¸Šçš„å˜é‡ï¼Œå®ƒå¼•ç”¨äº†å †ä¸Šçš„å¯¹è±¡ã€‚

**ç¬¬äºŒæ­¥ï¼šæ··åˆå±éšœè§„åˆ™**

æ ˆå¿«ç…§å®Œæˆåï¼Œç¨‹åºç»§ç»­è¿è¡Œï¼Œè¿™æ—¶å€™æ··åˆå†™å±éšœå¼€å§‹å‘æŒ¥ä½œç”¨ã€‚å®ƒçš„è§„åˆ™éå¸¸ç®€å•ä½†å¾ˆæœ‰æ•ˆï¼š

```go
// ä¼ªä»£ç ï¼šæ··åˆå†™å±éšœ
func hybridWriteBarrier(slot *unsafe.Pointer, ptr unsafe.Pointer) {
    // è§„åˆ™ 1ï¼šå¦‚æœè¦åˆ é™¤çš„å¯¹è±¡æ˜¯ç™½è‰²ï¼Œå°†å…¶æ ‡è®°ä¸ºç°è‰²ï¼ˆåˆ é™¤å±éšœçš„æ€æƒ³ï¼‰
    if *slot != nil && getColor(*slot) == WHITE {
        setColor(*slot, GRAY)
    }
    
    // è§„åˆ™ 2ï¼šå¦‚æœè¦æ’å…¥çš„å¯¹è±¡æ˜¯ç™½è‰²ï¼Œå°†å…¶æ ‡è®°ä¸ºç°è‰²ï¼ˆæ’å…¥å±éšœçš„æ€æƒ³ï¼‰
    if ptr != nil && getColor(ptr) == WHITE {
        setColor(ptr, GRAY)
    }
    
    // æ‰§è¡Œå®é™…çš„æŒ‡é’ˆèµ‹å€¼
    *slot = ptr
}
```

è¿™ä¸ªæ··åˆè§„åˆ™ç¡®ä¿äº†ï¼š

- ä»»ä½•ä»å †ä¸Šå¯¹è±¡è¢«åˆ é™¤å¼•ç”¨çš„ç™½è‰²å¯¹è±¡éƒ½ä¼šè¢«æ ‡è®°ä¸ºç°è‰²ï¼ˆç»§æ‰¿åˆ é™¤å±éšœçš„ä¿æŠ¤ï¼‰
- ä»»ä½•è¢«å †ä¸Šå¯¹è±¡æ–°å¼•ç”¨çš„ç™½è‰²å¯¹è±¡éƒ½ä¼šè¢«æ ‡è®°ä¸ºç°è‰²ï¼ˆç»§æ‰¿æ’å…¥å±éšœçš„ä¿æŠ¤ï¼‰
- æ ˆä¸Šçš„å¯¹è±¡å·²ç»åœ¨å¿«ç…§æ—¶è¢«æ ‡è®°ä¸ºé»‘è‰²ï¼Œä¸éœ€è¦å±éšœä¿æŠ¤

### ä¸ºä»€ä¹ˆæ··åˆå†™å±éšœè¿™ä¹ˆå·§å¦™ï¼Ÿ

æ··åˆå†™å±éšœçš„å·§å¦™ä¹‹å¤„åœ¨äºå®ƒè§£å†³äº†å‰é¢ä¸¤ç§å±éšœçš„æ ¸å¿ƒé—®é¢˜ï¼š

**è§£å†³æ ˆæ‰«æé—®é¢˜**ï¼š
ä¼ ç»Ÿçš„æ’å…¥å±éšœå’Œåˆ é™¤å±éšœéƒ½æ— æ³•åœ¨æ ˆä¸Šé«˜æ•ˆå·¥ä½œï¼Œå› ä¸ºæ ˆä¸Šçš„æŒ‡é’ˆä¿®æ”¹å¤ªé¢‘ç¹ã€‚æ··åˆå†™å±éšœé€šè¿‡åœ¨ GC å¼€å§‹æ—¶ç»™æ ˆä¸Šå¯¹è±¡"å…æ­»é‡‘ç‰Œ"çš„æ–¹å¼ï¼Œå½»åº•é¿å¼€äº†è¿™ä¸ªé—®é¢˜ã€‚

æƒ³è±¡ä¸€ä¸‹ï¼Œè¿™å°±åƒæ˜¯åœ¨ä¸€ä¸ªå¤§å‹æ´»åŠ¨å¼€å§‹å‰ï¼Œæ‰€æœ‰å·²ç»åˆ°åœºçš„ VIP éƒ½æ‹¿åˆ°äº†ç‰¹æ®Šé€šè¡Œè¯ï¼Œåç»­å°±ä¸éœ€è¦å†å¯¹ä»–ä»¬è¿›è¡Œå¤æ‚çš„å®‰æ£€æµç¨‹äº†ã€‚

**å‡ ä¹æ¶ˆé™¤ STW**ï¼š
æ··åˆå†™å±éšœåªéœ€è¦åœ¨å¼€å§‹æ—¶è¿›è¡Œå¾ˆçŸ­çš„ STW æ¥åšæ ˆå¿«ç…§ï¼Œåç»­çš„æ ‡è®°è¿‡ç¨‹å®Œå…¨å¯ä»¥ä¸ç”¨æˆ·ç¨‹åºå¹¶å‘æ‰§è¡Œï¼Œä¸éœ€è¦é¢å¤–çš„æ ˆé‡æ‰«æã€‚

### ä¸€ä¸ªå…·ä½“çš„ä¾‹å­

è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªå…·ä½“çš„ä¾‹å­æ¥çœ‹çœ‹æ··åˆå†™å±éšœæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼š

```go
func example() {
    // GC å¼€å§‹å‰çš„çŠ¶æ€
    var a *Object = &Object{name: "A"}  // åœ¨æ ˆä¸Š
    var b *Object = &Object{name: "B"}  // åœ¨æ ˆä¸Š
    a.ref = &Object{name: "C"}          // C åœ¨å †ä¸Š
    b.ref = &Object{name: "D"}          // D åœ¨å †ä¸Š
    
    // GC å¼€å§‹ï¼šæ ˆå¿«ç…§é˜¶æ®µ
    // æ­¤æ—¶ aã€b è¢«æ ‡è®°ä¸ºé»‘è‰²ï¼ˆæ ˆä¸Šå¯¹è±¡ï¼‰
    // Cã€D ä»ç„¶æ˜¯ç™½è‰²ï¼ˆç­‰å¾…æ ‡è®°ï¼‰
    
    // ç”¨æˆ·ç¨‹åºç»§ç»­è¿è¡Œï¼Œä¿®æ”¹å¼•ç”¨å…³ç³»
    a.ref = b.ref  // a ç°åœ¨æŒ‡å‘ Dï¼Œè§¦å‘æ··åˆå†™å±éšœ
}
```

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå½“æ‰§è¡Œ `a.ref = b.ref` æ—¶ï¼š

1. **åˆ é™¤å±éšœé€»è¾‘**ï¼š`a.ref` åŸæ¥æŒ‡å‘å¯¹è±¡ Cï¼ˆç™½è‰²ï¼‰ï¼Œå±éšœä¼šå°† C æ ‡è®°ä¸ºç°è‰²
2. **æ’å…¥å±éšœé€»è¾‘**ï¼š`b.ref` æŒ‡å‘å¯¹è±¡ Dï¼ˆç™½è‰²ï¼‰ï¼Œå±éšœä¼šå°† D æ ‡è®°ä¸ºç°è‰²
3. æ‰§è¡Œå®é™…çš„èµ‹å€¼æ“ä½œ

è¿™æ ·ï¼Œæ— è®ºå¯¹è±¡ C å’Œ D åç»­å¦‚ä½•è¢«å¼•ç”¨æˆ–è§£é™¤å¼•ç”¨ï¼Œå®ƒä»¬éƒ½ä¸ä¼šè¢«é”™è¯¯å›æ”¶ï¼Œå› ä¸ºå®ƒä»¬å·²ç»è¢«æ ‡è®°ä¸ºç°è‰²ï¼Œä¼šåœ¨åç»­çš„æ ‡è®°è¿‡ç¨‹ä¸­è¢«æ­£ç¡®å¤„ç†ã€‚

### æ··åˆå†™å±éšœçš„æ€§èƒ½ä¼˜åŠ¿

ç›¸æ¯”äºå‰é¢çš„æ–¹æ¡ˆï¼Œæ··åˆå†™å±éšœå¸¦æ¥äº†æ˜¾è‘—çš„æ€§èƒ½æå‡ï¼š

**STW æ—¶é—´æçŸ­**ï¼šåªéœ€è¦åœ¨å¼€å§‹æ—¶åšæ ˆå¿«ç…§ï¼Œé€šå¸¸åªéœ€è¦å‡ å¾®ç§’åˆ°å‡ æ¯«ç§’ï¼Œç›¸æ¯”ä¹‹å‰çš„å‡ åæ¯«ç§’ç”šè‡³æ›´é•¿æ—¶é—´æœ‰äº†è´¨çš„æå‡ã€‚

**å¹¶å‘ç¨‹åº¦é«˜**ï¼šæ ‡è®°è¿‡ç¨‹å‡ ä¹å®Œå…¨ä¸ç”¨æˆ·ç¨‹åºå¹¶å‘ï¼Œä¸ä¼šé˜»å¡ç¨‹åºçš„æ­£å¸¸æ‰§è¡Œã€‚

è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ Go 1.8 ä¹‹åçš„åƒåœ¾å›æ”¶å™¨èƒ½å¤Ÿå®ç°å¦‚æ­¤ä½çš„å»¶è¿Ÿã€‚æ··åˆå†™å±éšœçš„å¼•å…¥è®© Go çš„åƒåœ¾å›æ”¶å™¨çœŸæ­£è¾¾åˆ°äº†"è½¯å®æ—¶"çš„æ°´å¹³ï¼Œä¸º Go åœ¨é«˜æ€§èƒ½æœåŠ¡å™¨å¼€å‘é¢†åŸŸçš„æˆåŠŸå¥ å®šäº†é‡è¦åŸºç¡€ã€‚

ä½†æ˜¯ï¼Œåœ¨è¿™é‡Œï¼Œæ··åˆå†™å±éšœé€šè¿‡ä¿å®ˆåœ°åœ¨èµ‹å€¼æ—¶å°†ç™½è‰²å¯¹è±¡æ ‡ç°ï¼Œè™½ç„¶é¿å…äº†é”™è¯¯å›æ”¶çš„é£é™©ï¼Œä½†ä¹Ÿå¯èƒ½æ ‡è®°ä¸€äº›å®é™…ä¸Šå·²ç»ä¸å†ä½¿ç”¨çš„å¯¹è±¡ï¼Œä»è€Œå¯¼è‡´å®ƒä»¬è¦ç­‰åˆ°ä¸‹ä¸€è½® GC æ‰è¢«æ¸…ç†ï¼Œè¿™æ˜¯ä¸€ç§ä¸ºäº†ç¡®ä¿å®‰å…¨æ€§æ‰€åšçš„â€œå»¶è¿Ÿå›æ”¶â€æƒè¡¡ã€‚

## Go åƒåœ¾å›æ”¶çš„å®Œæ•´æµç¨‹

äº†è§£äº†ä¸‰è‰²æ ‡è®°æ³•å’Œæ··åˆå†™å±éšœçš„åŸç†åï¼Œè®©æˆ‘ä»¬æ¥çœ‹çœ‹ç°ä»£ Go åƒåœ¾å›æ”¶å™¨çš„å®Œæ•´å·¥ä½œæµç¨‹ã€‚æ•´ä¸ªè¿‡ç¨‹å°±åƒæ˜¯ä¸€åœºç²¾å¿ƒç¼–æ’çš„èˆè¹ˆï¼Œæ¯ä¸ªæ­¥éª¤éƒ½æœ‰å…¶ç‰¹å®šçš„ç›®çš„å’Œæ—¶æœºã€‚

### GC çš„è§¦å‘æ—¶æœº

Go çš„åƒåœ¾å›æ”¶å™¨ä¸æ˜¯å®šæ—¶è§¦å‘çš„ï¼Œè€Œæ˜¯åŸºäºå †å†…å­˜çš„ä½¿ç”¨æƒ…å†µåŠ¨æ€å†³å®šçš„ã€‚ä¸»è¦æœ‰ä»¥ä¸‹å‡ ç§è§¦å‘æ–¹å¼ï¼š

**è‡ªåŠ¨è§¦å‘ï¼ˆæœ€å¸¸è§ï¼‰**ï¼š
å½“å †å†…å­˜çš„ä½¿ç”¨é‡è¾¾åˆ°ä¸Šæ¬¡ GC åçš„ `GOGC%` æ—¶è‡ªåŠ¨è§¦å‘ã€‚é»˜è®¤ `GOGC=100`ï¼Œæ„å‘³ç€å †å¤§å°ç¿»å€æ—¶è§¦å‘ GCã€‚

```go
// ä¾‹å¦‚ï¼šä¸Šæ¬¡ GC åå †å¤§å°ä¸º 100MB
// å½“å †å¤§å°å¢é•¿åˆ° 200MB æ—¶ï¼Œè‡ªåŠ¨è§¦å‘ä¸‹ä¸€æ¬¡ GC
```

**æ‰‹åŠ¨è§¦å‘**ï¼š
ç¨‹åºå¯ä»¥é€šè¿‡è°ƒç”¨ `runtime.GC()` ä¸»åŠ¨è§¦å‘åƒåœ¾å›æ”¶ã€‚

**å†…å­˜å‹åŠ›è§¦å‘**ï¼š
å½“ç³»ç»Ÿå†…å­˜ä¸è¶³æ—¶ï¼ŒGo è¿è¡Œæ—¶ä¼šæ›´æ¿€è¿›åœ°è§¦å‘ GCã€‚

### å®Œæ•´çš„ GC æµç¨‹

ç°ä»£ Go çš„åƒåœ¾å›æ”¶è¿‡ç¨‹å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªé˜¶æ®µï¼š

**é˜¶æ®µ 1ï¼šæ ‡è®°å‡†å¤‡ï¼ˆMark Setupï¼‰**

è¿™ä¸ªé˜¶æ®µéœ€è¦çŸ­æš‚çš„ STWï¼Œä¸»è¦åšä¸‰ä»¶äº‹ï¼š

```go
// ä¼ªä»£ç ï¼šæ ‡è®°å‡†å¤‡é˜¶æ®µ
func markSetup() {
    stopTheWorld()  // å¼€å§‹ STW
    
    // 1. å¯ç”¨æ··åˆå†™å±éšœ
    enableWriteBarrier()
    
    // 2. ä¸ºæ‰€æœ‰ goroutine åšæ ˆå¿«ç…§
    for goroutine := range allGoroutines {
        scanGoroutineStack(goroutine)  // å°†æ ˆä¸Šå¯¹è±¡æ ‡è®°ä¸ºé»‘è‰²
    }
    
    // 3. å°†æ ¹å¯¹è±¡æ ‡è®°ä¸ºç°è‰²
    scanGlobalVariables()
    
    startTheWorld()  // ç»“æŸ STWï¼Œç”¨æˆ·ç¨‹åºç»§ç»­è¿è¡Œ
}
```

è¿™ä¸ªé˜¶æ®µçš„ STW æ—¶é—´é€šå¸¸åªæœ‰å‡ ååˆ°å‡ ç™¾å¾®ç§’ï¼Œå› ä¸ºåªéœ€è¦æ‰«ææ ˆå’Œå…¨å±€å˜é‡ï¼Œä¸éœ€è¦é€’å½’å¤„ç†å¯¹è±¡å¼•ç”¨ã€‚

**é˜¶æ®µ 2ï¼šå¹¶å‘æ ‡è®°ï¼ˆConcurrent Markï¼‰**

æ ‡è®°å‡†å¤‡å®Œæˆåï¼Œç¨‹åºæ¢å¤è¿è¡Œï¼Œåƒåœ¾å›æ”¶å™¨å¼€å§‹å¹¶å‘æ ‡è®°é˜¶æ®µã€‚è¿™ä¸ªé˜¶æ®µå®Œå…¨ä¸ç”¨æˆ·ç¨‹åºå¹¶å‘æ‰§è¡Œï¼š

```go
// ä¼ªä»£ç ï¼šå¹¶å‘æ ‡è®°é˜¶æ®µ
func concurrentMark() {
    // å¤„ç†æ‰€æœ‰ç°è‰²å¯¹è±¡
    for {
        obj := getGrayObject()
        if obj == nil {
            break  // æ²¡æœ‰æ›´å¤šç°è‰²å¯¹è±¡
        }
        
        // å°†å¯¹è±¡æ ‡è®°ä¸ºé»‘è‰²
        setColor(obj, BLACK)
        
        // æ‰«æå¯¹è±¡çš„æ‰€æœ‰å¼•ç”¨
        for ref := range obj.getReferences() {
            if getColor(ref) == WHITE {
                setColor(ref, GRAY)  // å°†ç™½è‰²å¯¹è±¡æ ‡è®°ä¸ºç°è‰²
            }
        }
    }
}
```

åœ¨è¿™ä¸ªé˜¶æ®µï¼Œç”¨æˆ·ç¨‹åºå¯èƒ½ä¼šä¸æ–­åœ°ä¿®æ”¹å¯¹è±¡å¼•ç”¨å…³ç³»ï¼Œæ··åˆå†™å±éšœä¼šç¡®ä¿è¿™äº›ä¿®æ”¹ä¸ä¼šå¯¼è‡´æ´»è·ƒå¯¹è±¡è¢«é”™è¯¯å›æ”¶ã€‚

**é˜¶æ®µ 3ï¼šæ ‡è®°ç»ˆæ­¢ï¼ˆMark Terminationï¼‰**

å½“æ‰€æœ‰ç°è‰²å¯¹è±¡éƒ½è¢«å¤„ç†å®Œæ¯•åï¼Œéœ€è¦å†æ¬¡çŸ­æš‚çš„ STW æ¥å®Œæˆæ ‡è®°ï¼š

```go
// ä¼ªä»£ç ï¼šæ ‡è®°ç»ˆæ­¢é˜¶æ®µ
func markTermination() {
    stopTheWorld()  // å¼€å§‹ STW
    
    // å¤„ç†åœ¨å¹¶å‘æ ‡è®°é˜¶æ®µäº§ç”Ÿçš„å‰©ä½™ç°è‰²å¯¹è±¡
    drainWorkQueue()
    
    // å…³é—­å†™å±éšœ
    disableWriteBarrier()
    
    // å‡†å¤‡æ¸…é™¤é˜¶æ®µ
    prepareSweep()
    
    startTheWorld()  // ç»“æŸ STW
}
```

è¿™ä¸ªé˜¶æ®µçš„ STW æ—¶é—´ä¹Ÿå¾ˆçŸ­ï¼Œé€šå¸¸åœ¨å‡ åå¾®ç§’å·¦å³ã€‚

**é˜¶æ®µ 4ï¼šå¹¶å‘æ¸…é™¤ï¼ˆConcurrent Sweepï¼‰**

æ¸…é™¤é˜¶æ®µä¹Ÿæ˜¯å¹¶å‘æ‰§è¡Œçš„ï¼Œå®ƒä¼šåœ¨åå°é€æ¸å›æ”¶æ‰€æœ‰ç™½è‰²å¯¹è±¡ï¼š

```go
// ä¼ªä»£ç ï¼šå¹¶å‘æ¸…é™¤é˜¶æ®µ
func concurrentSweep() {
    go func() {  // åœ¨åå° goroutine ä¸­æ‰§è¡Œ
        for span := range allMemorySpans {
            sweepSpan(span)  // æ¸…ç†å†…å­˜å—
        }
    }()
}

func sweepSpan(span *MemorySpan) {
    for obj := range span.objects {
        if getColor(obj) == WHITE {
            freeObject(obj)  // å›æ”¶ç™½è‰²å¯¹è±¡
        } else {
            setColor(obj, WHITE)  // é‡ç½®é¢œè‰²ä¸ºç™½è‰²ï¼Œå‡†å¤‡ä¸‹æ¬¡ GC
        }
    }
}
```

æ¸…é™¤é˜¶æ®µä¼šé€æ­¥é‡Šæ”¾å†…å­˜ï¼Œå¹¶å°†å­˜æ´»å¯¹è±¡çš„é¢œè‰²é‡ç½®ä¸ºç™½è‰²ï¼Œä¸ºä¸‹ä¸€è½® GC åšå‡†å¤‡ã€‚

## å®é™…åº”ç”¨ä¸­çš„åƒåœ¾å›æ”¶è°ƒä¼˜

ç†è§£äº† Go åƒåœ¾å›æ”¶çš„å·¥ä½œåŸç†åï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹åœ¨å®é™…å¼€å‘ä¸­å¦‚ä½•è°ƒä¼˜åƒåœ¾å›æ”¶å™¨çš„æ€§èƒ½ã€‚è™½ç„¶ Go çš„åƒåœ¾å›æ”¶å™¨å·²ç»éå¸¸æ™ºèƒ½ï¼Œä½†åœ¨æŸäº›ç‰¹å®šåœºæ™¯ä¸‹ï¼Œé€‚å½“çš„è°ƒä¼˜ä»ç„¶èƒ½å¤Ÿå¸¦æ¥æ˜¾è‘—çš„æ€§èƒ½æå‡ã€‚

### ç›‘æ§ GC æ€§èƒ½

åœ¨è¿›è¡Œä»»ä½•ä¼˜åŒ–ä¹‹å‰ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦äº†è§£å½“å‰ç¨‹åºçš„ GC è¡¨ç°ã€‚Go æä¾›äº†å¤šç§å·¥å…·æ¥ç›‘æ§åƒåœ¾å›æ”¶ï¼š

**ä½¿ç”¨ GODEBUG ç¯å¢ƒå˜é‡**ï¼š

```bash
GODEBUG=gctrace=1 go run main.go
```

è¿™ä¼šè¾“å‡ºè¯¦ç»†çš„ GC æ—¥å¿—ï¼Œç±»ä¼¼äºï¼š

```
gc 1 @0.012s 0%: 0.018+0.46+0.071 ms clock, 0.14+0.042/0.23/0.51+0.57 ms cpu, 4->4->2 MB, 5 MB goal, 8 P
```

è®©æˆ‘ä»¬è§£è¯»è¿™ä¸ªæ—¥å¿—ï¼š
- `gc 1`ï¼šç¬¬ 1 æ¬¡åƒåœ¾å›æ”¶
- `@0.012s`ï¼šç¨‹åºå¯åŠ¨å 0.012 ç§’è§¦å‘
- `0%`ï¼šGC å ç”¨çš„ CPU æ—¶é—´ç™¾åˆ†æ¯”
- `0.018+0.46+0.071 ms clock`ï¼šSTW æ—¶é—´ï¼ˆæ ‡è®°å‡†å¤‡ + æ ‡è®° + æ ‡è®°ç»ˆæ­¢ï¼‰
- `4->4->2 MB`ï¼šGC å‰å †å¤§å° -> GC åå †å¤§å° -> å­˜æ´»å¯¹è±¡å¤§å°
- `5 MB goal`ï¼šä¸‹æ¬¡ GC çš„è§¦å‘é˜ˆå€¼

**ä½¿ç”¨ runtime/debug åŒ…**ï¼š

```go
package main

import (
    "fmt"
    "runtime/debug"
    "time"
)

func monitorGC() {
    var stats debug.GCStats
    debug.ReadGCStats(&stats)
    
    fmt.Printf("GC æ¬¡æ•°: %d\n", stats.NumGC)
    fmt.Printf("æ€» GC æ—¶é—´: %v\n", stats.PauseTotal)
    if len(stats.Pause) > 0 {
        fmt.Printf("æœ€è¿‘ä¸€æ¬¡ GC æš‚åœæ—¶é—´: %v\n", stats.Pause[0])
    }
}

func main() {
    ticker := time.NewTicker(5 * time.Second)
    defer ticker.Stop()
    
    for {
        select {
        case <-ticker.C:
            monitorGC()
        }
    }
}
```

### è°ƒæ•´ GOGC å‚æ•°

`GOGC` æ˜¯æœ€é‡è¦çš„ GC è°ƒä¼˜å‚æ•°ï¼Œå®ƒæ§åˆ¶ç€ GC çš„è§¦å‘é¢‘ç‡ï¼š

```bash
# è®¾ç½® GOGC=200ï¼Œè¡¨ç¤ºå †å¤§å°å¢é•¿ 200% æ—¶è§¦å‘ GC
export GOGC=200

# è®¾ç½® GOGC=50ï¼Œè¡¨ç¤ºå †å¤§å°å¢é•¿ 50% æ—¶è§¦å‘ GC  
export GOGC=50

# ç¦ç”¨è‡ªåŠ¨ GCï¼ˆåªèƒ½æ‰‹åŠ¨è§¦å‘ï¼‰
export GOGC=off
```

**GOGC å€¼çš„é€‰æ‹©ç­–ç•¥**ï¼š

- **é«˜é¢‘ GCï¼ˆGOGC < 100ï¼‰**ï¼šé€‚ç”¨äºå†…å­˜æ•æ„Ÿçš„ç¯å¢ƒï¼ŒGC æ›´é¢‘ç¹ä½†æ¯æ¬¡å›æ”¶çš„å†…å­˜æ›´å°‘ï¼Œå»¶è¿Ÿæ›´ä½ä½†ååé‡å¯èƒ½ä¸‹é™
- **ä½é¢‘ GCï¼ˆGOGC > 100ï¼‰**ï¼šé€‚ç”¨äºå†…å­˜å……è¶³çš„ç¯å¢ƒï¼ŒGC ä¸é‚£ä¹ˆé¢‘ç¹ä½†æ¯æ¬¡å¤„ç†çš„å¯¹è±¡æ›´å¤šï¼Œååé‡æ›´é«˜ä½†å¯èƒ½æœ‰æ›´é•¿çš„å»¶è¿Ÿå³°å€¼

è®©æˆ‘ä»¬çœ‹ä¸€ä¸ªå®é™…çš„ä¾‹å­ï¼š

```go
package main

import (
    "fmt"
    "runtime"
    "time"
)

func allocateMemory() {
    // æ¨¡æ‹Ÿå†…å­˜åˆ†é…
    data := make([][]byte, 1000)
    for i := range data {
        data[i] = make([]byte, 1024*1024) // 1MB each
    }
    
    // è®©æ•°æ®ä¿æŒä¸€æ®µæ—¶é—´
    time.Sleep(100 * time.Millisecond)
}

func main() {
    var m1, m2 runtime.MemStats
    
    runtime.ReadMemStats(&m1)
    fmt.Printf("å¼€å§‹å‰ - å †å¤§å°: %d KB, GC æ¬¡æ•°: %d\n", 
        m1.HeapAlloc/1024, m1.NumGC)
    
    // åˆ†é…å¤§é‡å†…å­˜
    for i := 0; i < 10; i++ {
        allocateMemory()
    }
    
    runtime.ReadMemStats(&m2)
    fmt.Printf("ç»“æŸå - å †å¤§å°: %d KB, GC æ¬¡æ•°: %d\n", 
        m2.HeapAlloc/1024, m2.NumGC)
    
    fmt.Printf("è§¦å‘äº† %d æ¬¡ GC\n", m2.NumGC-m1.NumGC)
}
```

### å‡å°‘ GC å‹åŠ›çš„ç¼–ç¨‹æŠ€å·§

é™¤äº†è°ƒæ•´å‚æ•°ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡æ”¹è¿›ä»£ç æ¥å‡å°‘ GC å‹åŠ›ï¼š

**å¯¹è±¡æ± æŠ€æœ¯**ï¼š

å¯¹äºé¢‘ç¹åˆ›å»ºå’Œé”€æ¯çš„å¯¹è±¡ï¼Œå¯ä»¥ä½¿ç”¨å¯¹è±¡æ± æ¥é¿å…é‡å¤åˆ†é…ï¼š

```go
package main

import (
    "sync"
)

// ä½¿ç”¨ sync.Pool å®ç°å¯¹è±¡æ± 
var bufferPool = sync.Pool{
    New: func() interface{} {
        return make([]byte, 1024) // åˆ›å»º 1KB ç¼“å†²åŒº
    },
}

func processData(data []byte) {
    // ä»æ± ä¸­è·å–ç¼“å†²åŒº
    buffer := bufferPool.Get().([]byte)
    defer bufferPool.Put(buffer) // ç”¨å®Œåæ”¾å›æ± ä¸­
    
    // ä½¿ç”¨ç¼“å†²åŒºå¤„ç†æ•°æ®
    copy(buffer, data)
    // ... å¤„ç†é€»è¾‘
}
```

**é¿å…ä¸å¿…è¦çš„æŒ‡é’ˆ**ï¼š

å‡å°‘æŒ‡é’ˆçš„ä½¿ç”¨å¯ä»¥é™ä½ GC æ‰«æçš„è´Ÿæ‹…ï¼š

```go
// ä¸å¥½çš„åšæ³•ï¼šå¤§é‡æŒ‡é’ˆ
type BadNode struct {
    Value *int
    Next  *BadNode
}

// æ›´å¥½çš„åšæ³•ï¼šå‡å°‘æŒ‡é’ˆä½¿ç”¨
type GoodNode struct {
    Value int    // ç›´æ¥å­˜å‚¨å€¼è€Œä¸æ˜¯æŒ‡é’ˆ
    Next  *GoodNode
}

// å¯¹äºå¤§é‡æ•°æ®ï¼Œè€ƒè™‘ä½¿ç”¨æ•°ç»„è€Œä¸æ˜¯é“¾è¡¨
type DataArray struct {
    Values []int  // è¿ç»­å†…å­˜ï¼ŒGC æ‰«ææ›´é«˜æ•ˆ
}
```

**æ‰¹é‡å¤„ç†**ï¼š

å°†å¤šä¸ªå°æ“ä½œåˆå¹¶ä¸ºä¸€ä¸ªå¤§æ“ä½œï¼Œå‡å°‘å†…å­˜åˆ†é…æ¬¡æ•°ï¼š

```go
// ä¸å¥½çš„åšæ³•ï¼šé¢‘ç¹å­—ç¬¦ä¸²æ‹¼æ¥
func badStringConcat(parts []string) string {
    result := ""
    for _, part := range parts {
        result += part  // æ¯æ¬¡éƒ½ä¼šåˆ›å»ºæ–°å­—ç¬¦ä¸²
    }
    return result
}

// æ›´å¥½çš„åšæ³•ï¼šä½¿ç”¨ strings.Builder
func goodStringConcat(parts []string) string {
    var builder strings.Builder
    builder.Grow(len(parts) * 10) // é¢„åˆ†é…å®¹é‡
    for _, part := range parts {
        builder.WriteString(part)
    }
    return builder.String()
}
```

### ç‰¹æ®Šåœºæ™¯çš„è°ƒä¼˜ç­–ç•¥

ä¸åŒçš„åº”ç”¨åœºæ™¯éœ€è¦ä¸åŒçš„è°ƒä¼˜ç­–ç•¥ï¼š

**Web æœåŠ¡å™¨**ï¼š
- ä¼˜å…ˆè€ƒè™‘å“åº”å»¶è¿Ÿï¼Œå¯ä»¥è®¾ç½®è¾ƒå°çš„ GOGC å€¼ï¼ˆå¦‚ 50-80ï¼‰
- ä½¿ç”¨è¿æ¥æ± ã€å¯¹è±¡æ± ç­‰æŠ€æœ¯å‡å°‘ä¸´æ—¶å¯¹è±¡åˆ†é…
- ç›‘æ§æ¯ä¸ªè¯·æ±‚çš„å†…å­˜åˆ†é…æƒ…å†µ

**æ‰¹å¤„ç†ä»»åŠ¡**ï¼š
- ä¼˜å…ˆè€ƒè™‘ååé‡ï¼Œå¯ä»¥è®¾ç½®è¾ƒå¤§çš„ GOGC å€¼ï¼ˆå¦‚ 200-400ï¼‰
- å¤„ç†å®Œä¸€æ‰¹æ•°æ®åæ‰‹åŠ¨è°ƒç”¨ `runtime.GC()` è¿›è¡Œæ¸…ç†
- è€ƒè™‘åˆ†æ‰¹å¤„ç†å¤§æ•°æ®é›†ï¼Œé¿å…ä¸€æ¬¡æ€§åŠ è½½è¿‡å¤šæ•°æ®

**å®æ—¶ç³»ç»Ÿ**ï¼š
- å¯¹å»¶è¿Ÿæå…¶æ•æ„Ÿï¼Œå¯èƒ½éœ€è¦ç¦ç”¨è‡ªåŠ¨ GCï¼ˆGOGC=offï¼‰
- æ‰‹åŠ¨æ§åˆ¶ GC è§¦å‘æ—¶æœºï¼Œåœ¨ä¸šåŠ¡ä½å³°æœŸè¿›è¡Œæ¸…ç†
- ä½¿ç”¨å†…å­˜é¢„åˆ†é…ç­–ç•¥ï¼Œé¿å…è¿è¡Œæ—¶çš„å†…å­˜åˆ†é…

é€šè¿‡åˆç†çš„ç›‘æ§ã€å‚æ•°è°ƒæ•´å’Œä»£ç ä¼˜åŒ–ï¼Œæˆ‘ä»¬å¯ä»¥è®© Go çš„åƒåœ¾å›æ”¶å™¨æ›´å¥½åœ°ä¸ºæˆ‘ä»¬çš„åº”ç”¨æœåŠ¡ï¼Œåœ¨ä¿è¯ç¨‹åºæ­£ç¡®æ€§çš„åŒæ—¶è·å¾—æœ€ä½³çš„æ€§èƒ½è¡¨ç°ã€‚

## æ€»ç»“

ä»æœ€åˆçš„æ ‡è®°-æ¸…é™¤ç®—æ³•åˆ°ç°åœ¨çš„æ··åˆå†™å±éšœï¼ŒGo è¯­è¨€çš„åƒåœ¾å›æ”¶å™¨ç»å†äº†ä¸€ä¸ªä¸æ–­è¿›åŒ–å’Œä¼˜åŒ–çš„è¿‡ç¨‹ã€‚è¿™ä¸ªè¿‡ç¨‹å°±åƒæ˜¯ä»é©¬è½¦æ—¶ä»£è¿›å…¥åˆ°äº†è‡ªåŠ¨é©¾é©¶æ±½è½¦æ—¶ä»£â€”â€”ä¸ä»…è§£æ”¾äº†ç¨‹åºå‘˜çš„åŒæ‰‹ï¼Œè¿˜æä¾›äº†æ›´å®‰å…¨ã€æ›´é«˜æ•ˆçš„å†…å­˜ç®¡ç†ä½“éªŒã€‚

åœ¨ä»Šå¤©çš„äº‘åŸç”Ÿæ—¶ä»£ï¼ŒGo è¯­è¨€å‡­å€Ÿå…¶å‡ºè‰²çš„åƒåœ¾å›æ”¶èƒ½åŠ›ï¼Œæˆä¸ºäº†æ„å»ºé«˜æ€§èƒ½æœåŠ¡å™¨åº”ç”¨çš„é¦–é€‰è¯­è¨€ä¹‹ä¸€ã€‚ä» Docker åˆ° Kubernetesï¼Œä» Prometheus åˆ° Istioï¼Œè¿™äº›æ”¹å˜ä¸–ç•Œçš„é¡¹ç›®éƒ½é€‰æ‹©äº† Goï¼Œå¾ˆå¤§ç¨‹åº¦ä¸Šæ­£æ˜¯å› ä¸ºå®ƒèƒ½å¤Ÿåœ¨ä¿è¯å¼€å‘æ•ˆç‡çš„åŒæ—¶æä¾›å‡ºè‰²çš„è¿è¡Œæ—¶æ€§èƒ½ã€‚

å½“ç„¶ï¼ŒGo çš„åƒåœ¾å›æ”¶å™¨ä»åœ¨ä¸æ–­è¿›åŒ–ã€‚Go å›¢é˜ŸæŒç»­åœ¨é™ä½å»¶è¿Ÿã€æé«˜ååé‡ã€å‡å°‘å†…å­˜å ç”¨ç­‰æ–¹é¢è¿›è¡Œä¼˜åŒ–ã€‚æœªæ¥æˆ‘ä»¬å¯èƒ½ä¼šçœ‹åˆ°æ›´å¤šä»¤äººå…´å¥‹çš„æ”¹è¿›ï¼Œæ¯”å¦‚æ›´æ™ºèƒ½çš„ GC è°ƒåº¦ã€æ›´ç²¾ç¡®çš„å†…å­˜ç®¡ç†ç­‰ç­‰ã€‚

ä½œä¸º Go ç¨‹åºå‘˜ï¼Œæˆ‘ä»¬ä¸éœ€è¦æˆä¸ºåƒåœ¾å›æ”¶ä¸“å®¶ï¼Œä½†ç†è§£å…¶åŸºæœ¬åŸç†å’Œè°ƒä¼˜æ–¹æ³•ï¼Œèƒ½å¤Ÿå¸®åŠ©æˆ‘ä»¬å†™å‡ºæ›´é«˜æ•ˆçš„ä»£ç ï¼Œåœ¨éœ€è¦çš„æ—¶å€™è¿›è¡Œæœ‰é’ˆå¯¹æ€§çš„ä¼˜åŒ–ã€‚è¿™å°±åƒå¼€è½¦ä¸€æ ·â€”â€”ä½ ä¸éœ€è¦æˆä¸ºæ±½è½¦å·¥ç¨‹å¸ˆï¼Œä½†äº†è§£å‘åŠ¨æœºçš„åŸºæœ¬å·¥ä½œåŸç†ï¼Œèƒ½å¤Ÿè®©ä½ æ›´å¥½åœ°é©¾é©­ä½ çš„åº§é©¾ã€‚

å¸Œæœ›é€šè¿‡ä»Šå¤©çš„æ¢è®¨ï¼Œä½ å¯¹ Go è¯­è¨€çš„åƒåœ¾å›æ”¶æœºåˆ¶æœ‰äº†æ›´æ·±å…¥çš„ç†è§£ã€‚ä¸‹æ¬¡å½“ä½ çš„ Go ç¨‹åºåœ¨åå°é™é™åœ°è¿›è¡Œåƒåœ¾å›æ”¶æ—¶ï¼Œä½ å°±çŸ¥é“é‚£é‡Œæ­£åœ¨å‘ç”Ÿç€å¤šä¹ˆç²¾å¦™çš„é­”æ³•ã€‚